---
title: "Analyse av kvalitetskontroller for enkeltkjøretøyregistreringer"
output: 
  html_notebook:
    theme: cerulean
    number_sections: true
    toc: true
    toc_float: 
      collapsed: false
      smooth_scroll: false
    toc_depth: 2
---

```{r setup, message=F, include=FALSE}
library(tidyverse)
library(knitr)
library(cowplot) # may be replaced på patchwork here?
library(patchwork)
library(lubridate)
library(rmarkdown)
library(RColorBrewer)

knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      cache = TRUE,
                      dev = "ragg_png")
```


# Bakgrunn
Når trafikkdatasystemet mottar data om en kjøretøyregistrering fra et trafikkregistreringspunkt, lagres dette i *rådatabasen* uten videre prosessering. Etter at ryddegutt har sjekket at alle data er overført for en klokketime, sendes alle data gjennom en kvalitetskontroll og lagres i databasen for *kontrollerte data*.

Kvalitetskontrollene gjøres fordi data som kommer inn ikke alltid er gode nok til sitt formål. Kontrollene ble først utarbeidet i samråd med dataloggerleverandørene, samt basert på Statens vegvesens testing der fasiten ble laget på grunnlag av manuell gjennomgang av videoopptak kombinert med kjøretøyopplysninger fra Kjøretøyregisteret.

Kvalitetskontrollene deles inn i to sett, og gjelder for enten

  - alle dataloggertyper, eller
  - hver spesifikk dataloggertype (og firmwareversjon).
  
Hensikten med kontrollene er å merke data som har for lav kvalitet. Utgangspunktet er at alle data er av god nok kvalitet dersom de ikke faller utenfor krav som stilles i kontrollene. 
  
I dette dokumentet er det kun data fra registreringer av motorkjøretøy som er omtalt. Det omfatter kun to dataloggertyper: Loop Monitor (LM) og EMU3.


## Kontroller som gjelder alle dataloggertyper
Uansett hvilken dataloggertype data kommer fra, så gjelder følgende:

  - Selve registreringen er ugyldig dersom:
    - Kjørefeltverdien er fraværende.
    - Kjørefeltverdien er utenfor de kjørefeltene som eksisterer på trafikkregistreringspunktet.
    - Eventnummer mangler.
    - Lengdeverdien mangler.

  - Lengde og klassifisering er ugyldig dersom:
    - Lengde er \< 1 m eller \> 27 m.
    - Lengdeverdien mangler.

  - Fart er ugyldig dersom:
    - Absoluttverdi av fart \> 300 km/h.


## Dataloggerspesifikke kontroller
For **LM** gjelder følgende:

  - Fart, lengde og klassifisering er ugyldig dersom:
    - Absoluttverdi av fart \< 7 km/h. (LM angir ingen lengde når farten er så lav.)

  - Fart og lengde er ugyldig dersom:
    - ::: {style="color:green"}
      Fartsulikhet* \>= 25 % for fart \>= 100 km/h, eller \>= 25 km/h for fart \< 100 km/h. (Endret i mars 2020 fra 3 % / 3 km/h.)
      :::
    - Fartsulikhetsverdien mangler.
    - Fartsverdien mangler.

 - Klassifisering er ugyldig dersom:
    - Signalkoden inneholder oddetall eller 0, unntatt 0202.
    - Signalkoden mangler.
    
\*Fartsulikhet fra LM er det absolutte avviket (i km/h) mellom sløyfe 1 og 2.

For **EMU3** gjelder følgende:

  - Fart og lengde er ugyldig dersom:
    - Absoluttverdi av fart \< 7 km/h.
    - Fartsverdien mangler.

  - Fart, lengde og klassifisering er ugyldig dersom:
    - ::: {style="color:red"}
      Fartsulikhet ≠ 0 (omsatt fra "Change of speed validity bit" satt til TRUE).
      :::
    - Fartsulikhetsverdien mangler.


## Analysens formål
Noen trafikkregistreringspunkter har høy andel underkjente lengdemålinger. Er dette reellt eller er kontrollene for strenge? Hva er grunnen til at lengdemålingene blir underkjente? Målet med analysen er å finne ut hvor godt kontrollene treffer og eventuelt justere dem. Om kontrollene justeres, skal alle data i Trafikkdatasystemet reberegnes tilbake til 2014.

Denne analysen tar ikke for seg deteksjonsgraden av antall kjøretøy, men er konsentrert om måleverdiene for lengde og klassifisering som tilhører de faktisk registrerte kjøretøyene.


# Metode
Det antas at kvaliteten på fartsmålingene henger nøye sammen med kvaliteten på lengdemålingene. Det er kjøretøylengden vi kan finne fasit på i Kjøretøyregisteret, så derfor er lengden i fokus for denne analysen. Kjøretøyregisteret er også fasit for kjøretøyklassifiseringen.


## Feilsituasjoner
Ved god flyt i trafikken, god kvalitet på sløyfene og ingen delvise sløyfepasseringer blir datakvaliteten veldig god, også for lengdemålingene. Dette er blant annet dokumentert i Statens vegvesens tester på Øysand testtrekning. Likevel kan det forekomme tilfeldig målefeil, men det antas at dette forekommer sjeldent.

Lavere datakvalitet oppstår av ulike årsaker som grovt kan deles inn i tre kategorier:

  - Feil på sløyfer:
    - betydelig ulik frekvens på sløyfer i samme felt
    - frekvens utenfor toleranseområde
    - elektronisk støy (kan være årsak til de to førstnevnte)
    - ingen frekvens (sløyfebrudd, ikke tilkoblet sløyfe eller dårlig koblet sløyfe, kortslutning)
    - sløyfene lagt med feil dimensjon (systematisk feilkilde)
  - Delvis passering av sløyfer
  - Saktegående eller stillestående trafikk (lav fart)
  - Høy akselerasjon, typisk på ramper (fartsulikhet)
  
De ulike feilsituasjonene kan gi opphav til ekstreme måleverdier som avslører lav datakvalitet:

  - Lengde utenfor (1, 27) m
  - Fart under 7 km/h
  - Speed quality 
    - over 3 for LM
    - ulik 0 for EMU3
    
Måleverdier som er innenfor grenseverdiene kan også være feil, men det er vanskeligere å avsløre. Denne analysen fokuserer på å finne de grenseneverdiene som passer best til våre krav om datakvalitet.


## Framgangsmåte
For å gjennomføre analysen, gjøres følgende:

  1. Finn et punkt med høy andel underkjente lengder
  2. Beskriv stedlige forhold:
    - antall felt
    - fartsnivå
    - sløyfestatus
    - trafikale forhold
  4. Sannsynliggjør årsak til feil
  5. Se på et utvalg av data for ett kjørefelt og finn eventuelle sammenhenger mellom lengde, klasse, fart og fartsulikhet
  6. Vurder om grenseverdiene er fornuftige
  
  
## Delanalyser

  1. Hvilke kontroller underkjenner lengder?
  2. Hvilke lengder blir underkjent?
  3. Er det sammenheng i kvaliteten på kjøretøyklasse og lengde?
  4. Lengde utenfor (1, 27) m: lengde ok?
  6. Lengde utenfor (1, 27) m: klasse ok?
  7. Fart under 7 km/h: lengde ok?
  8. Fart under 7 km/h: klasse ok?
  9. Fartsulikhet over 3 eller ulik 0: lengde ok?
  10. Fartsulikhet over 3 eller ulik 0: klasse ok?
  11. LM: forskjell i frekvens på \> 20 kHz - lengde ok?


# Analyse av data fra LM
Denne analysedelen ble gjennomført i februar 2020. Endret kontrollsett for LM ble implementert da og alle tidligere data ble reberegnet innen april 2020.

I det følgende er det sett på data fra 20. februar 2020, om ikke annet er oppgitt.


## Punkter med lav datakvalitet
Liste over trafikkregistreringspunkter som har flest tilfeller innenfor de angitte, spesielle måleverdiene:

  - **lengde under 1 m**
    - Moholtlia, fire felt: har sløyfefeil.
    - Kannik, fire felt: kø? Gjelder felt 2 og 4.
    - Drengsrud ved Liahagen, fire felt: Gjelder spesielt felt 3.
    - Hansjordnestunnelen: kryss og kø. I felt 2 og 4.
    - Høvik, fire felt: felt 1 (liten andel).

  - **lengde mellom 1 og 2 m**
    - E10 Moskenes arm til ferge: kø?, felt 1 (høy andel).
    - Gansås: ukjent årsak.
    - Postterminalen: kryss, kø.
    - Grillstadtunnelen vest, fire felt: feltskifte?
    - Puddefjordsbroen ved Laksevåg: sving, kryss, kø.

  - **lengde over 29 m**
    - Drengsrud ved Liahagen, fire felt: felt 3.
    - Sundland, fire felt: feltskifte og/eller sløyfefeil.
    - Høvik, fire felt: felt 1 (liten andel).
    - Moholtlia, fire felt: sløyfefeil.
    - E10 Moskenes arm til ferge: kø? (høy andel).

  - **fart under 7 km/h**
    -  Kannik, fire felt: kø? i felt 2 og 4.
    -  Moholtlia, fire felt: sløyfefeil.
    -  Drengsrud ved Liahagen, fire felt: felt 3.
    -  Hansjordnestunnelen: kryss, kø, felt 2 og 4.
    -  Høvik, fire felt: felt 1 (liten andel).

  - **fartsulikhet over 3**
    - Skullerud hovedkjørefelt, firefelt.
    - Taraldrud, firefelt.
    - Smihagen enveg med, firefelt.
    - Sundland, firefelt.
    - Kroppan bru, firefelt.

Punkter med kø, ugunstig sensorplassering eller dårlige sløyfer

  - 54688V625212 Skullerud hovedkjørefelt (feltskifte?)
  - 14354V2486023 Hålogalandsbrua (sløyfefeil, støy?)
  - 68557V444232 Blommenholm (feltskifte?)
  - 06970V72811 Kroppan bru (dårlige sløyfer i motretning)
  - 94949V444217 Smihagen enveg med (feltskifte?)
  - 68234V443152 Taraldrud (feltskifte felt 4?)
  - 48379V625405 St. Ringvei Nydalsbrua (feltskifte?)
  - 68351V319882 Kannik (sløyfefeil)
  - 00000V1993681 Ytrebygdveien (feltskifte?)

Andre punkter med høy andel underkjente lengder:

-   Årøytunnelen, Søyland, Klinga, Sønsterud, Eggetunnelen, Reinsvoll, Asker og sikkert flere, ingen godkjente i ene feltet pga fartsulikhet, som nok skyldes 20 kHz forskjell på sløyfene der.
-   Vassbotn brua, veldig ulik frekvens på flere sløyfer, mye fartsulikhet 10-15


## Sløyfer med ulik frekvens
Dagens kontrollsett gir ukjent lengde for de fleste passeringer i felt der det er stor forskjell i frekvensen på de to sløyfene. Typisk eksempel er der hvor en sløyfe har omkring 65 kHz og den andre ligger rundt 85 kHz. Sistnevnte er normalt frekvensnivå.

Hva som er grunnen til at en sløyfe har omtrent 20 kHz lavere frekvens enn normalt, er ukjent.


### Ev 18 Asker
Egenskaper:

  - Fire felt
  - Fart mellom 60 og 120 km/h
  - En sløyfe i felt 3 har 20 kHz lavere enn de andre sløyfene
  - God flyt i trafikken

```{r asker, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_asker)
```

Vurdering:

  - Ulik frekvens på sløyfene i det ene feltet gir høyere fartsulikhet-verdier her, men både lengde- og fartsmålinger, samt klassifisering, synes ikke å avvike fra felt med normal frekvens.


### Fv 44 Søyland
Egenskaper:

  - To felt
  - Fart mellom 50 og 90 km/h
  - En sløyfe i felt 2 har 20 kHz lavere enn de andre sløyfene
  - Grei flyt i trafikken 
  
```{r soyland, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_soyland)
```

Vurdering:

  - Ulik frekvens på sløyfene i det ene feltet gir høyere fartsulikhet-verdier her, men både lengde- og fartsmålinger, samt klassifisering, synes ikke å avvike fra felt med normal frekvens.
  
  
### Ev 39 Øysand F05
På teststasjon F05 har vi tilfellet med ulik frekvens på sløyfene i felt 2. Frekvensen ligger på omkring 65 og 85 kHz. Felt 2 har stort sett fartsulikhet over 3 og dermed underkjente lengdemålinger.

Egenskaper:

  - To felt
  - Fart på rundt 80 km/h
  - En sløyfe i felt 2 har 20 kHz lavere enn de andre sløyfene
  - Stort sett god flyt i trafikken

```{r f05, fig.height=12, fig.width=8}
plot_all_in_one(vbv_f05)
```

Vurdering:

  - Ulik frekvens på sløyfene i det ene feltet gir høyere fartsulikhet-verdier her, men både lengde- og fartsmålinger, samt klassifisering, synes ikke å avvike fra felt med normal frekvens.


## Lav frekvens på alle sløyfer
Noen punkter har jevnt lav frekvens på alle sløyfene, men likevel innenfor oppgitt toleranseområde.


### Fv 5004 Hollundsvegen
Egenskaper:

  - To felt
  - 0 - 60 km/h
  - Alle fire sløyfer har frekvens på ca. 55 kHz
  - Tidvis saktegående trafikk
  
```{r hollundsvegen, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_hollundsvegen)
```

Vurdering:

  - Mange kjøretøy får lengde under 2 m og noen får 29 m, men fartsulikhet er ingen god indikator på dette.
  - Skulle sett nærmere på lengdene mellom 1 og 2 m. Mange av disse er klassifisert som motorsykkel, men er det riktig?
  

### Fv 542 Svortland vest
Egenskaper:

  - To felt
  - 10 - 100 km/h
  - Alle fire sløyfer har frekvens på ca. 65 kHz
  - Tidvis saktegående trafikk

```{r svortlandv, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_svortland_vest)
```

Vurdering:

  - Mange kjøretøy får lengde under 2 m og noen får 29 m, men speed quality er ingen god indikator på dette.
  - Skulle sett nærmere på lengdene mellom 1 og 2 m.
  

## Brudd eller dårlig koblet sløyfe


### Ev 6 Moholtlia
Egenskaper:

  - Fire felt
  - 10 - 75 km/h
  - Stort sett god flyt i trafikken
  - Feil på en av sløyfene i felt 4, ellers frekvenser rundt 70 kHz

```{r moholtlia, fig.height=12, fig.width=8}
plot_all_in_one(vbv_moholtlia)
```

Vurdering:

  - I felt 4 får de fleste kjøretøy omtrent maksimal fartsulikhet, dvs. at den ene fartsmålingen er nær null.
  - Mange av lengdemålingene får en bestemt maksimal- eller minimumsverdi av LM, som er utenfor vårt godkjenningsintervall.
  - Fartsulikhet og ekstrem lengde ser her ut til å være en god indiaktor på lav datakvalitet for lengde og klassifisering.


## Saktegående trafikk


### Fv 542 Svortland øst
Egenskaper:

  - To felt
  - 0 - 75 km/h
  - Tidvis saktegående trafikk
  - Alle fire sløyfer har normal frekvens på ca. 85 kHz

```{r svortlando, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_svortland_ost)
```

Vurdering:

  - Noen lave hastigheter gir bestemte feilverdier for lengde, satt av LM. Disse er utenfor vårt toleranseområde for lengde, men har ikke særlig høy fartsulikhet.


### Fv 862 Postterminalen
![Punktet Postterminalen er markert med gult.](vbv_data/postterminalen.png)

Egenskaper:

  - Tre felt, men felt 2 er flettefelt, med en stor andel delvise sløyfepasseringer.
  - Tidvis saktegående trafikk. Forventer en del kø i felt 1.
  - Alle sløyfer viser normal frekvens på rundt 85 kHz.

```{r postterminalen, fig.height=12, fig.width=8}
plot_all_in_one(vbv_postterminalen)
```

Ser nærmere på korte lengder.

```{r postterminalen2, fig.height=12, fig.width=8}
vbv_postterminalen %>% 
  dplyr::filter(vehicle_type == 1 | length < 2.5) %>%
  plot_all_in_one()
```

Vurdering:

  - I felt 2 er det ikke lavt fartsnivå, men høy andel delvise passeringer. Mange kjøretøy blir her klassifisert som motorsykkel, men det er nok stort avvik fra virkeligheten. Det er likevel god overensstemmelse mellom lengde og klassifisering, selv om en del kjøretøy får angitt standarlengde. En del kjøretøy har større fartsulikhet, men det er ikke noe klart skille.
  - I felt 1 og 3 er det både lav fart og delvise sløyfepasseringer. Spesielt i felt 1 ser det ut som om lengdene er noe lengre enn vanlig. Det går heller ikke her noe klart skille på fartsulikhet.


### Fv 6690 Elgeseter bru
Egenskaper:

  - Fire felt.
  - Tidvis saktgående trafikk.
  - Mange metrobusser på 24,5 m.
  - Sløyfefrekvenser:
    - felt 1 og 3: ca. 70 kHz
    - felt 2: 65 og 85
    - felt 4: 85

```{r elgeseter, fig.height=12, fig.width=8}
plot_all_in_one(vbv_elgeseter)
```

Vurdering:

-   En del tilfeller at at fartsulikhet er større enn fartsmålingen. Det må komme av at de to fartsmålingene har ulikt fortegn. Kan dette være en indikasjon på delvis sløyfepassering og/eller saktegående trafikk?


#### Data fra 24. februar 2020
Stort snøfall, ingen forventede mc, skuter o.l.

```{r elgeseter2, fig.height=12, fig.width=8}
plot_all_in_one(vbv_elgeseter_2)
```

Ser nærmere på registreringer som enten er klassifisert som motorsykkel eller har lengde under 3,5 m.

```{r elgeseter2_korte, fig.height=12, fig.width=8}
vbv_elgeseter_2 %>% 
  dplyr::filter(vehicle_type == 1 | length < 2.5) %>% 
  plot_all_in_one()
```

Vurdering:

  - Føreforhold tilsier at det ikke skal være noen motorsykler, men likevel er mange klassifisert som nettopp det. Det antas at dette skyldes feltskifte med delvise sløyfepasseringer. De har heller ikke lav fart.
  - Hverken lengde eller fartsulikhet gir et tydelig skille på korrekt klassifisering.


## Feltskifte
Ved felskifte akkurat over sensorene blir det delvis passering av sløyfene.


### Ev 6 Skullerud
Egenskaper:

  - God flyt i trafikken, noe saktegående i felt 2.
  - Normal frekvens på alle sløyfer.
  - Muligens en del feltskifte.

```{r skullerud, fig.height=12, fig.width=8}
plot_all_in_one(vbv_skullerud)
```

Vurdering:

  - Noen ganske lange kjøretøy har veldig høy fart i felt 4. Dette virker lite troverdig. Det skyldes kanskje delvis passering. Her ser fartsulikhet til å være en god indikator på det. 


# Analyse av data fra EMU3
For EMU3 må vi ta hensyn til at ulike firmwareversjoner har hatt ulik grenseverdi for fartulikhet:

- Før 25. januar 2017: fartsulikhetsgrensen var programmert til 25 % i firmware, men den ble ikke benyttet til kontroll. Alle fartsulikhetsverdier fra EMU3 før dette er manglende ("null"). Fra denne datoen ble de første EMU3 oppgradert til ny firmwareversjon og de første punktene begynte å få verdi.

Problemstilling: kontrollen setter alle lengder ugyldig når fartsulikhet er manglende, og den er jo nettopp det for tidligere fw-versjoner. Når alle data for et punkt reberegnes, vil alle lengder fra denne første tiden settes som ugyldig, og det blir jo feil. Dagens kontroller er ikke firmwarespesfikke, men de reviderte må ta hensyn til dette. Spørsmålet er om vi bare skal være strenge med data fra nyeste versjonene?

- Januar 2017: grensen ble endret fra 25 % til 3 % i Secondary 2.11.10. Denne kom et drøyt år før 1.0-versjonen for samlet firmwarepakke. Men denne inneholdt en feil som gjorde at grensen var 3 % på felt 5-8 og 25 % på felt 1-4.

- April 2018: 2.17.1 rettet feilen nevnt over slik at alle felt 1-8 fikk grense på 3 %. Den første samlede fw-pakken var 1.01, og den hadde 2.17.4. Noen tidligere varianter av usamlet fw hadde 2.17.4, men ingen andre med secondary på 2.17.x. Det betyr at kun firmware med "*Secondary=2.17.4*" eller "*1.0x*" har hatt grensen på 3 % på alle felt. Og det er først da vi kan ha en konsistent kontroll.


## Punkter med lav datakvalitet
Den første stasjonen med en EMU3 var 1500018 Flote som ble igangsatt 23. juli 2015. Her ble det byttet til LM i desember 2015. Den første stasjonen som fortsatt har EMU3 er 1500028 Valldal (like ved Trollstigen, så trafikken kan variere en god del).

Må finne ut om lengdemålingene har vært vesentlig forskjellige for de ulike fw-versjonene.

Firefeltsveg:

  - Ev 39 Somaveien
  - Ev 39 Jåtten
  - Ev 6 Leirelva bru
  - Ev 6 Furuset N
  - Ev6 Klemetsrud

Lav lengdekvalitetsgrad i ÅDT:

  - TODO


## Sløyfer med ulik frekvens


## Lav frekvens på alle sløyfer


## Brudd eller dårlig koblet sløyfe


## Saktegående trafikk


## Feltskifte


## Samme punkt, ulik firmware
Har måleverdiene endret seg med firmware.


## Samme punkt, ulik datalogger
Har måleverdiene endret seg ved bytte av datalogger (samme sløyfer)



# Sammenligning av LM og EMU3
Teststrekningen på Ev 39 ved Øysand har tre sløyfesett (F05, F07, F09) plassert rett etter hverandre. Dermed kan den samme trafikken sammenlignes på ulike dataloggere og firmwareversjoner.

I felt 2 på F05 har en av sløyfene lavere frekvens enn normalt, og for LM gir dette typisk noe lengre lengder enn de samme målingene i felt 2 på F07 og F09.


## Generell fordeling av lengdemålinger
Analyse av data fra uke 23, 2021, mandag 7. juni - onsdag 9. juni. Følgende oppsett for sløyfesett, datalogger og firmware:

- F05: LM 1.14.419
- F07: EMU3 1.04
- F09: LM 1.14.419

Ser på den empiriske kumulative fordelingen av lengdemålinger.

```{r gof}
#ks.test(f09$length, f07$length)
#ks.test(f05_1$length, f09_1$length)

# TODO: anderson-darling test?
```


```{r oysand_ecdf, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "mandag") %>% 
  plot_ecdf("Øysand, 7. juni 2021")
```

```{r oysand_ecdf_2, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_ecdf("Øysand, 8. juni 2021")
```


```{r oysand_ecdf_3, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "onsdag") %>% 
  plot_ecdf("Øysand, 9. juni 2021")
```

Resultatene er konsistente over disse tre dagene, og viser at EMU3 måler noe lengre lengder enn LM i felt 1. I felt 2 måler LM noe lengre lengder, men dette skyldes nok at den ene sløyfa der er litt dårlig.

Ser på tilsvarende kvantilplott.

```{r oysand_qq_1}
oysand_2021w23 %>%
  dplyr::filter(weekday == "mandag") %>% 
  plot_qq("Øysand, 7. juni 2021")
```

```{r oysand_qq_2}
oysand_2021w23 %>%
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_qq("Øysand, 8. juni 2021")
```

```{r oysand_qq_3}
oysand_2021w23 %>%
  dplyr::filter(weekday == "onsdag") %>% 
  plot_qq("Øysand, 9. juni 2021")
```

Også her vises klart at LM på F05 har lengre lengder i felt 2. Ellers er det ganske likt.


## Sammenligning av flere måleverdier
Ser på data fra tre dager i juni og sammenligner per felt.

```{r oysand_compare_1, fig.height=12, fig.width=8}
oysand_2021w23 %>%
  dplyr::filter(lane_number == "felt 1") %>%
  plot_all_in_one()
```


```{r oysand_compare_2, fig.height=12, fig.width=8}
oysand_2021w23 %>%
  dplyr::filter(lane_number == "felt 2") %>%
  plot_all_in_one()
```

Grovt sett er det veldig likt. Fartsulikhet virker ikke å være noen god indikator på data med lav kvalitet verken for EMU3 eller LM.

## Lengdeklassifisering
Hvordan påvirkes lengdeklassifiseringen av at dataloggerne har litt ulike lengder?


```{r oysand_bars_2021_06_07}
oysand_2021w23_agg_length_class_full %>% 
  dplyr::filter(weekday == "mandag") %>% 
  plot_length_class_bars(length_class_full, "Øysand, 7. juni 2021")
```

```{r oysand_bars_2021_06_08}
oysand_2021w23_agg_length_class_full %>% 
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_length_class_bars(length_class_full, "Øysand, 8. juni 2021")
```

```{r oysand_bars_2021_06_09}
oysand_2021w23_agg_length_class_full %>% 
  dplyr::filter(weekday == "onsdag") %>% 
  plot_length_class_bars(length_class_full, "Øysand, 9. juni 2021")
```

```{r oysand_bars_2_2021_06_07}
oysand_2021w23_agg_length_class_2 %>% 
  dplyr::filter(weekday == "mandag") %>% 
  plot_length_class_bars(length_class_2, "Øysand, 7. juni 2021")
```

```{r oysand_bars_2_2021_06_08}
oysand_2021w23_agg_length_class_2 %>% 
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_length_class_bars(length_class_2, "Øysand, 8. juni 2021")
```

```{r oysand_bars_2_2021_06_09}
oysand_2021w23_agg_length_class_2 %>% 
  dplyr::filter(weekday == "onsdag") %>% 
  plot_length_class_bars(length_class_2, "Øysand, 9. juni 2021")
```




```{r heavy_ratio, fig.height=4, fig.width=8}
plot_heavy_ratio(oysand_2021w23_agg_length_class_2_heavy_ratio)
```

Tendensen er at EMU3 har større andel tunge kjøretøy. Det er også her tydelig hvordan feilen på den ene sløyfa på F05 gir større andel i felt 2.


### Sammenligning av kjøretøy mot kjøretøy
Med data fra 12. april 2021 er lengdemålingene sammenlignet mellom EMU3 på F05 (1.04) og LM på F09 (1.14.419).

```{r vbv_1}
plot_vbv_data(EMU3_F05, 1, "Forskjell i registrert lengde mellom EMU3 (F05) og LM (F09)")
```

```{r vbv_2}
plot_vbv_data(EMU3_F05, 2, "Forskjell i registrert lengde mellom EMU3 (F05) og LM (F09)")
```

Også for EMU3 blir det lengre lengder i felt 2 på F05. De som har underkjent lengde hos EMU3 her kommer for det meste av at fartsulikhetsverdien er ulik 0.

Med data fra 27. mars 2020 er lengdemålingene sammenlignet mellom EMU3 på F07 (1.04) og LM på F09 (1.14.414).


```{r vbv_3}
plot_vbv_data(EMU3_F07, 1, "Forskjell i registrert lengde mellom EMU3 (F07) og LM (F09)")
```

```{r vbv_4}
plot_vbv_data(EMU3_F07, 2, "Forskjell i registrert lengde mellom EMU3 (F07) og LM (F09)")
```

Det er gjennomgående litt avvik på lengdemålingene til de to dataloggerne. Fartsulikhet, som fører til underkjent lengde, gir ikke noe tydelig skille på hvor like (gode) lengdemålingene er.


# Oppsummering og konklusjon
Oppsummering av analysene og forslag til endring av kontroller.


## Oppsummering for LM

**Ulik frekvens på sløyfer**

Selv om ulik frekvens på sløyfer gir høyere verdier på fartsulikhet, ser både lengde- og fartsmålinger helt greie ut. På Øysand ser det ut til at lengdene blir noe lengre, men ikke av særlig betydning. 

Bruk av fartsulikhet som indikator på lav datakvalitet er ikke hensiktsmessig i dette tilfellet.


**Lav frekvens på alle sløyfer**

Lav frekvens på alle sløyfer gir mange korte lengder. Fartsulikhet skiller ikke på målinger med vanlige lengder og de under 2 m eller over 27 m. En nærmere undersøkelse av de korte kjøretøyene bør gjennomføres for å sjekke om klassifiseringen er god.


**Kø**

Gir både en del lengder 1,2-2 m, og 20-29 m. Mange feilklassifiseres som motorsykkel.


**Delvis passering av sløyfer**

Gir stor andel 1,2-2 m selv med fart godt over 15 km/h. Mange feilklassifiseres som motorsykkel.


**Feil på sløyfe**

Dersom en av to sløyfer i samme kjørefelt er ødelagt (frakoblet e.l.) blir det mange lengder på 29 m.


### Konklusjon for LM
Etter å ha sett på mye data i Kibana (visualisering "Ukjent lengde histogram"), viser det seg at kontrollene som underkjenner lengdemålingene fordeler seg som følger:

  - Fart under 7 km/h (får ingen lengde av LM): noen få utslag av denne kontrollen.
  - Lengde utenfor (1, 27) m: noen få utslag av denne kontrollen.
  - **Qspeed større enn 3: de fleste utslagene skyldes denne kontrollen.**
  - Det er en del lengder mellom 1 og 2 m som har underkjent klasse, men fart over 7 km/h - disse er slått ut av signalkodekontrollen.
  

Nytt kontrollsett:

-   **Fart under 7 km/h** gir underkjent fart, lengde og klasse. LM gir ikke lengde på disse, og de fleste får klasse 10 eller 11. **uendret kontroll**
-   **Lengde under 1 m** gir underkjent lengde (**ny kontroll**, de under får godkjent klasse, men de fleste er likevel ukjente).
-   **Lengde over 27 m** gir underkjent lengde (**ny kontroll**, innebærer at de utenfor får godkjent klasse - dette er en hypotese som må testes!)
-   **Signalkoden inneholder oddetall eller 0, unntatt 0202** gir underkjent klasse og lengde(?) (**ny kontroll**, hvis den også skal gjelde lengde - må testes)
-   **Klassekode 10, 11 eller tom** gir underkjent klasse (sjekk om dette er implementert slik)
-   **Qspeed over 25** gir underkjent fart og lengde (**ny kontroll**, dvs. ny grenseverdi).

Resultatene av denne undersøkelsen viser at vi må justere enkelte kontroller. Det er kontrollene som benytter fartsulikhet vi må endre, dvs. øke grenseverdien får når fartsulikhet fører til underkjent lengde og klassifisering. Da vil vi i mye større grad vise fram data som har god nok datakvalitet til lengde- og kjøretøyklassifisering enn det vi gjør i dag.


## EMU3

  
Hvilke kontroller underkjenner lengder:

  - Fart under 7 km/h:
    <p style="color:red">TODO</p>

  - Lengde utenfor (1, 27) m:
    <p style="color:red">TODO</p>

  - Speed_quality ≠ 0:
    <p style="color:red">TODO</p>

[Analyse pågår.]


### Konklusjon for EMU3
Foreløpig forslag til revisjon:

  - qspeed = *null* skrotes (var aldri ment å skulle gjelde?). Vil føre til at "alle" lengder fra fw tidligere enn de nevnt nedenfor blir godkjent. Må verifiseres at dette er rimelig.
  - fartsulikhet-kontroll gjelder kun for fw med konsistent verdi for fartsulikhet (s2.17.4 og 1.0x)
  

## Øvrige konklusjoner
Dataloggerne  bruker noen standardverdier for enkelte kjøretøyregistreringer:

LM:

  -	Manglende lengde: settes når farten er under 7 km/h.
  -	1,2 m: minimumslengde på signal som blir tolket som motorsykkel, men har usikker lengde pga. ikke-perfekt signalforløp.
  -	1,95 m: minimumslengde på signal som blir tolket som personbil, men har usikker lengde pga. ikke-perfekt signalforløp.
  -	29 m: maksimumslengde på signal som blir tolket som personbil, men har usikker lengde pga. ikke-perfekt signalforløp. Denne kan også inntreffe dersom lastebil passerer med en personbil liggende tett bak.

EMU3:

  -	1,25 m: minimumslengde for kjøretøy generelt. Usikre lengdemålinger som blir kortere, får automatisk satt lengden til 1,25 m. De fleste klassifiseres som motorsykkel, men også noen biler får denne lengden. Opptrer typisk i forbindelse med delvis passering.
  
**Klassifisering av motorsykler**

Det virker vanskelig å klassifisere motorsykler. Fra før vet vi at mange motorsykler "unnslipper" sløyfene ved å plassere seg for langt ut i kanten av kjørefeltet. I tillegg oppstår det mange falske motorsykler ved feltskifte og lav fart. En vurdering av om klassifisering av motorsykler er god nok må gjøres for hvert punkt.

**Gjenstående analyser**:

  - Hva er korrekt klassifisering av kjøretøy som får målt lengde under 2 m. Er alle disse lette kjøretøy?
  - Lengde på 29 m gir underkjent lengde. Bør testes om klasse og fart er ok. De fleste har fart 7-15 km/h. Mange her har klasse 8, 72, 1 eller 2 - litt skeptisk til klasse.... Relativt høy andel med høy fartsulikhet.
  - Finn ut om signalkodekontrollen til LM skal slå ut på lengde også.
  - Er det mulig å avdekke sensorproblemer ut fra lengdeverdier?
  

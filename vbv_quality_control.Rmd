---
title: "Analyse av kvalitetskontroller for enkeltkjøretøyregistreringer"
output: 
  html_notebook:
    theme: cerulean
    number_sections: true
    toc: true
    toc_float: 
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
---

```{r setup, message=F, include=FALSE}
library(tidyverse)
library(knitr)
library(cowplot)
library(lubridate)
library(rmarkdown)
library(RColorBrewer)

knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      cache = TRUE,
                      dev = "ragg_png")
```

```{r functions, include=FALSE}
read_kibana_vbv <- function(vbv_file) {
  read_csv2(vbv_file) %>%
  dplyr::mutate(lane = as.character(lane),
                vehicle_type = as.character(vehicle_type))
}

plot_scatterplot_length <- function(vbv_data) {
  vbv_data %>%
  ggplot() + 
  geom_point(aes(qspeed, length, color = lane)) +
  geom_vline(aes(xintercept = 3)) +
  geom_hline(aes(yintercept = 2)) +
  geom_hline(aes(yintercept = 5.6), color = "grey") +
  geom_hline(aes(yintercept = 27)) +
  scale_color_discrete() +
  theme_minimal()
}

plot_speed_qspeed <- function(vbv_data) {
  vbv_data %>%
  ggplot() + 
  geom_point(aes(qspeed, speed, color = lane)) +
  geom_vline(aes(xintercept = 3)) +
  scale_color_discrete() +
    theme_minimal()
}

plot_speed_relqspeed <- function(vbv_data) {
  vbv_data %>%
    mutate(relative_qspeed = qspeed / speed) %>% 
  ggplot() + 
  geom_point(aes(relative_qspeed, speed, color = lane)) +
  scale_color_discrete() +
    theme_minimal()
}

plot_length_class <- function(vbv_data) {
  vbv_data %>%
  ggplot() + 
  geom_point(aes(qspeed, length, color = vehicle_type)) +
  geom_vline(aes(xintercept = 3)) +
  geom_hline(aes(yintercept = 2)) +
  geom_hline(aes(yintercept = 5.6), color = "grey") +
  geom_hline(aes(yintercept = 27)) +
  scale_color_discrete() +
    theme_minimal()
}

plot_length_class_per_lane <- function(vbv_data) {
  vbv_data %>%
    group_by(lane) %>% 
    ggplot() + 
    geom_point(aes(qspeed, length, color = vehicle_type)) +
    facet_wrap(. ~ lane, labeller = label_both) +
    geom_vline(aes(xintercept = 3)) +
    geom_hline(aes(yintercept = 2)) +
    geom_hline(aes(yintercept = 5.6), color = "grey") +
    geom_hline(aes(yintercept = 27)) +
    scale_color_discrete() +
    theme_minimal()
}

plot_length_class_per_lane_relqspeed <- function(vbv_data) {
  vbv_data %>%
    mutate(relative_qspeed = qspeed / speed) %>%
    group_by(lane) %>% 
    ggplot() + 
    geom_point(aes(relative_qspeed, length, color = vehicle_type)) +
    facet_wrap(. ~ lane, labeller = label_both) +
    geom_hline(aes(yintercept = 2)) +
    geom_hline(aes(yintercept = 5.6), color = "grey") +
    geom_hline(aes(yintercept = 27)) +
    scale_color_discrete() +
    theme_minimal()
}

plot_all_in_one <- function(vbv_data) {
  cowplot::plot_grid(plot_scatterplot_length(vbv_data),
                   plot_speed_qspeed(vbv_data),
                   plot_length_class_per_lane(vbv_data),
                   ncol = 1)
}

plot_ecdf <- function(df, subtitle_text) {
  
  df %>% 
  ggplot(aes(length, color = name_and_datalogger)) +
  stat_ecdf(pad = FALSE,
            size = 1, alpha = 0.7) +
  facet_grid(rows = vars(lane)) +
  theme_minimal() +
  scale_color_brewer(
      palette = "Dark2",
      name = "Datalogger og punkt") +
  theme(strip.text.y = element_text(angle = 90),
        strip.background = element_rect(fill = "#F5F5F5"),
        legend.position = "bottom") +
  labs(x = "\nLengde (m)", y = "Kumulativ tetthet\n") +
  ggtitle("Kumulativ fordeling av lengdemålinger",
          subtitle = subtitle_text)
}

plot_qq <- function(df, subtitle_text) {
 
  df %>%  
  ggplot(aes(sample = length, color = name_and_datalogger)) +
  facet_grid(rows = vars(lane)) +
  stat_qq(size = 1, alpha = 0.7) +
  theme_minimal() +
  scale_color_brewer(
      palette = "Dark2",
      name = "Datalogger og punkt") +
  theme(strip.text.y = element_text(angle = 90),
        strip.background = element_rect(fill = "#F5F5F5"),
        legend.position = "bottom")+
  ggtitle("Kvantilplott av lengdemålinger",
          subtitle = subtitle_text)
}

plot_length_class_bars <- function(df, length_class_type, subtitle_text) {
  
  # length_class_type must be either 
  # length_class_full
  # or
  #length_class_2
  
  df %>% 
  ggplot(aes(x = {{ length_class_type }}, y = volume, fill = name_and_datalogger)) +
  ggplot2::geom_col(position = "dodge") +
  facet_grid(rows = vars(lane)) +
  theme_minimal() +
  scale_fill_viridis_d(name = "Datalogger",
                       option = "cividis") +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.text.y = element_text(angle = 90),
        strip.background = element_rect(fill = "#F5F5F5"),
        legend.position = "bottom",
        legend.key = element_blank()) +
  labs(x = "\nLengdeklasse", y = "Trafikkmengde\n") +
  ggtitle("Trafikkmengde per lengdeklasse",
          subtitle = subtitle_text)
}
```

```{r get_data, message=F, warning=F, error=F, include=F}
# LM ----
## Vbv data exported from Kibana
vbv_data_asker <- 
  read_kibana_vbv("vbv_data/asker.csv")
vbv_data_soyland <- 
  read_kibana_vbv("vbv_data/soyland.csv")
vbv_data_hollundsvegen <- 
  read_kibana_vbv("vbv_data/hollundsvegen.csv")
vbv_data_svortland_vest <-
  read_kibana_vbv("vbv_data/svortland_vest.csv")
vbv_data_svortland_ost <-
  read_kibana_vbv("vbv_data/svortland_ost.csv")
vbv_postterminalen <- 
  read_kibana_vbv("vbv_data/postterminalen.csv")
vbv_elgeseter <- 
  read_kibana_vbv("vbv_data/elgeseter_bru.csv")

## Elgeseter bru 24.02.2020: mye snø og neppe noen faktiske mc eller skuter
vbv_elgeseter_2 <- 
  read_kibana_vbv("vbv_data/elgeseter_bru_20200224.csv")
vbv_moholtlia <- 
  read_kibana_vbv("vbv_data/moholtlia.csv")
vbv_f05 <- 
  read_kibana_vbv("vbv_data/oysand_f05.csv")
vbv_skullerud <- 
  read_kibana_vbv("vbv_data/skullerud.csv")

```


# Bakgrunn
Når trafikkdatasystemet mottar data om en kjøretøyregistrering fra et trafikkregistreringspunkt, lagres dette i *rådatabasen* uten videre prosessering. Etter at ryddegutt har sjekket at alle data er overført for en klokketime, sendes alle data gjennom en kvalitetskontroll og lagres i databasen for *kontrollerte data*.

Kvalitetskontrollene gjøres fordi data som kommer inn ikke nødvendigvis er helt korrekte. Kontrollene ble først utarbeidet i samråd med dataloggerleverandørene, samt basert på egen testing der fasiten ble laget på grunnlag av manuell gjennomgang av videoopptak kombinert med kjøretøyopplysninger fra Kjøretøyregisteret.

Kvalitetskontrollene deles inn i to sett, etter hva de gjelder for:

  - alle dataloggertyper, eller
  - hver spesifikk dataloggertype (og firmwareversjon).
  
Hensikten med kontrollene er å merke data som har for lav kvalitet. Utgangspunktet er at alle data er av god nok kvalitet dersom de ikke faller utenfor krav som inngår i kontrollene. 
  
I dette dokumentet er det kun data fra registreringer av motorkjøretøy som er omtalt. Det omfatter kun to dataloggertyper: Loop Monitor (LM) og EMU3.


## Kontroller som gjelder alle dataloggertyper
Uansett hvilken dataloggertype data kommer fra, så gjelder følgende:

  - Selve registreringen er ugyldig dersom:
    - Kjørefeltverdien er fraværende.
    - Kjørefeltverdien er utenfor de kjørefeltene som eksisterer på trafikkregistreringspunktet.
    - Eventnummer mangler (er "null").

  - Lengde og klassifisering er ugyldig dersom:
    - Lengde er \< 1 m eller \> 27 m.

  - Fart er ugyldig dersom:
    - Absoluttverdi av fart \> 300 km/h.


## Dataloggerspesifikke kontroller
For **LM** gjelder følgende:

  - Fart, lengde og klassifisering er ugyldig dersom:
    - Absoluttverdi av fart \< 7 km/h. (LM angir ingen lengde når farten er så lav.)

  - Fart og lengde er ugyldig dersom:
    - ::: {style="color:green"}
      Speed_quality* \>= 3 % for fart \>= 100 km/h, eller \>= 3 km/h for fart \< 100 km/h. OBS! Endret mars 2020 til 25 % / 25 km/h.
      :::

 - Klassifisering er ugyldig dersom:
    - Signalkoden inneholder oddetall eller 0, unntatt 0202.
    
\*Speed_quality er for LM absolutt avvik (i km/h) mellom loop 1 og 2.

For **EMU3** gjelder følgende:

  - Fart og lengde er ugyldig dersom:
    - Absoluttverdi av fart \< 7 km/h.

  - Fart, lengde og klassifisering er ugyldig dersom:
    - ::: {style="color:red"}
      Speed_quality ≠ 0 (omsatt fra "Change of speed validity bit" satt til TRUE).
      :::
    - Grenseverdien for å sette speed_quality ≠ 0 er har variert med firmwareversjoner:
        -   (UNDER VURDERING)


# Formål
Noen trafikkregistreringspunkter har høy andel underkjente lengdemålinger. Er dette reellt eller er kontrollene for strenge? Hva er grunnen til at lengdemålingene blir underkjente? Målet med analysen er å finne ut hvor godt kontrollene treffer og eventuelt justere dem. Om kontrollene justeres, skal alle data i Trafikkdatasystemet reberegnes tilbake til 2014.


# Metode
Det antas at kvaliteten på fartsmålingene henger nøye sammen med kvaliteten på lengdemålingene. Det er kjøretøylengden vi kan finne fasit på i kjøretøyregisteret, så derfor er lengden i fokus for denne analysen. Det samme gjelder også kjøretøyklassifiseringen.


## Feilsituasjoner
Ved god flyt i trafikken, god kvalitet på sløyfene og ingen delvise passeringer blir datakvaliteten veldig god, også for lengdemålingene. Likevel kan det forekomme tilfeldig målefeil, men det antas at dette forekommer sjeldent.

Denne analysen tar ikke for seg deteksjonsgraden av antall kjøretøy, men er konsentrert om måleverdiene som tilhører de faktisk registrerte kjøretøyene.

Lavere datakvalitet oppstår av ulik årsaker som grovt kan deles inn i tre kategorier:

  - Feil på sløyfer:
    - betydelig ulik frekvens på sløyfer i samme felt
    - frekvens utenfor toleranseområde
    - ingen frekvens (sløyfebrudd, ikke tilkoblet sløyfe eller dårlig koblet sløyfe, kortslutning)
    - elektronisk støy (kan være årsak til de to førstnevnte)
    - sløyfene lagt med feil dimensjon (systematisk feilkilde)
  - Delvis passering av sløyfer
  - Saktegående eller stillestående trafikk (lav fart)
  - Høy akselerasjon, typisk på ramper (Speed quality)
  
De ulike feilsituasjonene gir opphav til måleverdier med for lav datakvalitet:

  - Lengde utenfor (1, 27) m
  - Fart under 7 km/h
  - Speed quality 
    - over 3 for LM
    - ulik 0 for EMU3
    
Analysen går derfor ut på å sjekke om lengde og klasse virkelig er tilstrekkelig feil utenfor disse grenseverdiene, eller om grensene bør justeres.

## Framgangsmåte
For å gjennomføre analysen, gjøres følgende:

  1. Finn et punkt med høy andel underkjente lengder
  2. Beskriv stedlige forhold:
    - antall felt
    - fartsnivå
    - sløyfestatus
    - trafikale forhold
  4. Sannsynliggjør årsak til feil
  5. Se på et utvalg av data og finn eventuelle sammenhenger mellom lengde, klasse, fart og speed quality. (Skill på felt)
  6. Vurder om grenseverdiene er fornuftige
  
  
## Delanalyser

  1. Er lengde og klasse ok om alle måleverdier er innenfor grenseverdiene? REFERER TIL TIDLIGERE TESTING
  2. Hvilke kontroller underkjenner lengder?
  3. Hvilke lengder blir underkjent?
  4. Er det sammenheng i kvaliteten på kjøretøyklasse og lengde?
  5. Lengde utenfor (1, 27) m: lengde ok?
  6. Lengde utenfor (1, 27) m: klasse ok?
  7. Fart under 7 km/h: lengde ok?
  8. Fart under 7 km/h: klasse ok?
  9. Speed quality over 3 eller ulik 0: lengde ok?
  10. Speed quality over 3 eller ulik 0: klasse ok?
  11. LM: forskjell i frekvens på 20 kHz - lengde ok?


# Eksempler på data fra LM
Denne delen ble gjennomført i februar 2020. Endret kontrollsett for LM ble implementert da og alle tidligere data ble reberegnet innen april 2020.


## Punkter med mange underkjente lengder
Liste over trafikkregistreringspunkter som har flest tilfeller innenfor de angitte, spesielle måleverdiene:

  - **lengde under 1 m**
    - Moholtlia, fire felt: har sløyfefeil.
    - Kannik, fire felt: kø? Gjelder felt 2 og 4.
    - Drengsrud ved Liahagen, fire felt: Gjelder spesielt felt 3.
    - Hansjordnestunnelen: kryss og kø. I felt 2 og 4.
    - Høvik, fire felt: felt 1 (liten andel).

  - **lengde mellom 1 og 2 m**
    - E10 Moskenes arm til ferge: kø?, felt 1 (høy andel).
    - Gansås: ukjent årsak.
    - Postterminalen: kryss, kø.
    - Grillstadtunnelen vest, fire felt: feltskifte?
    - Puddefjordsbroen ved Laksevåg: sving, kryss, kø.

  - **lengde over 29 m**
    - Drengsrud ved Liahagen, fire felt: felt 3.
    - Sundland, fire felt: feltskifte og/eller sløyfefeil.
    - Høvik, fire felt: felt 1 (liten andel).
    - Moholtlia, fire felt: sløyfefeil.
    - E10 Moskenes arm til ferge: kø? (høy andel).

  - **fart under 7 km/h**
    -  Kannik, fire felt: kø? i felt 2 og 4.
    -  Moholtlia, fire felt: sløyfefeil.
    -  Drengsrud ved Liahagen, fire felt: felt 3.
    -  Hansjordnestunnelen: kryss, kø, felt 2 og 4.
    -  Høvik, fire felt: felt 1 (liten andel).

  - **qspeed over 3**
    - Skullerud hovedkjørefelt, firefelt.
    - Taraldrud, firefelt.
    - Smihagen enveg med, firefelt.
    - Sundland, firefelt.
    - Kroppan bru, firefelt.

Punkter med kø, ugunstig sensorplassering eller dårlige sløyfer

  - 54688V625212 Skullerud hovedkjørefelt (feltskifte?)
  - 14354V2486023 Hålogalandsbrua (sløyfefeil, støy?)
  - 68557V444232 Blommenholm (feltskifte?)
  - 06970V72811 Kroppan bru (dårlige sløyfer i motretning)
  - 94949V444217 Smihagen enveg med (feltskifte?)
  - 68234V443152 Taraldrud (feltskifte felt 4?)
  - 48379V625405 St. Ringvei Nydalsbrua (feltskifte?)
  - 68351V319882 Kannik (sløyfefeil)
  - 00000V1993681 Ytrebygdveien (feltskifte?)

Andre punkter med høy andel underkjente lengder:

-   Årøytunnelen, Søyland, Klinga, Sønsterud, Eggetunnelen, Reinsvoll, Asker og sikkert flere, ingen godkjente i ene feltet pga qspeed, som nok skyldes 20 kHz forskjell på sløyfene der.
-   Vassbotn brua, veldig ulik frekvens på flere sløyfer, mye qspeed 10-15


## Eksempel på normalsituasjon
For sammenligning.

TODO

## Eksempler med feil
I det følgende er det sett på data fra 20. februar 2020, om ikke annet er oppgitt.


### Sløyfer med ulik frekvens
Dagens kontrollsett gir ukjent lengde for de fleste passeringer i felt der det er stor forskjell i frekvensen på de to sløyfene. Typisk eksempel er der hvor en sløyfe har omkring 65 kHz og den andre ligger rundt 85 kHz. Sistnevnte er normalt frekvensnivå.

Hva som er grunnen til at en sløyfe har omtrent 20 kHz lavere frekvens enn normalt, er ukjent.


#### Ev 18 Asker
Egenskaper:

  - Fire felt
  - Fart mellom 60 og 120 km/h
  - En sløyfe i felt 3 har 20 kHz lavere enn de andre sløyfene
  - God flyt i trafikken

```{r asker, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_asker)
```

Vurdering:

  - Ulik frekvens på sløyfene i det ene feltet gir høyere qspeed-verdier her, men både lengde- og fartsmålinger, samt klassifisering, synes ikke å avvike fra felt med normal frekvens.


#### Fv 44 Søyland
Egenskaper:

  - To felt
  - Fart mellom 50 og 90 km/h
  - En sløyfe i felt 2 har 20 kHz lavere enn de andre sløyfene
  - Grei flyt i trafikken 
  
```{r soyland, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_soyland)
```

Vurdering:

  - Ulik frekvens på sløyfene i det ene feltet gir høyere qspeed-verdier her, men både lengde- og fartsmålinger, samt klassifisering, synes ikke å avvike fra felt med normal frekvens.
  
  
#### Ev 39 Øysand F05
På teststasjon F05 har vi tilfellet med ulik frekvens på sløyfene i felt 2. Frekvensen ligger på omkring 65 og 85 kHz. Felt 2 har stort sett qspeed over 3 og dermed underkjente lengdemålinger. Er disse likevel gode nok når vi har fasit på lengdemålinger fra Kjøretøyregisteret?

Egenskaper:

  - To felt
  - Fart på rundt 80 km/h
  - En sløyfe i felt 2 har 20 kHz lavere enn de andre sløyfene
  - Stort sett god flyt i trafikken

```{r f05, fig.height=12, fig.width=8}
plot_all_in_one(vbv_f05)
```

Vurdering:

  - Ulik frekvens på sløyfene i det ene feltet gir høyere qspeed-verdier her, men både lengde- og fartsmålinger, samt klassifisering, synes ikke å avvike fra felt med normal frekvens.


### Lav frekvens på alle sløyfer
Noen punkter har jevnt lav frekvens på alle sløyfene, men likevel innenfor oppgitt toleranseområde.


#### Fv 5004 Hollundsvegen
Egenskaper:

  - To felt
  - 0 - 60 km/h
  - Alle fire sløyfer har frekvens på ca. 55 kHz
  - Tidvis saktegående trafikk
  
```{r hollundsvegen, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_hollundsvegen)
```

Vurdering:

  - Mange kjøretøy får lengde under 2 m og noen får 29 m, men speed quality er ingen god indikator på dette.
  - Skulle sett nærmere på lengdene mellom 1 og 2 m.
  

#### Fv 542 Svortland vest
Egenskaper:

  - To felt
  - 10 - 100 km/h
  - Alle fire sløyfer har frekvens på ca. 65 kHz
  - Tidvis saktegående trafikk

```{r svortlandv, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_svortland_vest)
```

Vurdering:

  - Mange kjøretøy får lengde under 2 m og noen får 29 m, men speed quality er ingen god indikator på dette.
  - Skulle sett nærmere på lengdene mellom 1 og 2 m.
  

### Brudd eller dårlig koblet sløyfe


#### Ev 6 Moholtlia
Egenskaper:

-   Fire felt.
-   Stort sett god flyt i trafikken.
-   Feil på en av sløyfene i felt 4, ellers frekvenser rundt 70 kHz.

```{r moholtlia, fig.height=12, fig.width=8}
plot_all_in_one(vbv_moholtlia)
```

Vurdering:

-   Når vi ser på fartsmålingene i felt 4, ser vi at de fleste kjøretøy får omtrent maksimal qspeed, dvs. at den ene fartsmålingen er nær null uansett.
-   Mange av lengdemålingene får en bestemt maksimal- eller minimumsverdi av LM, som i begge tilfeller er utenfor vårt godkjenningsintervall.


### Saktegående trafikk


#### Fv 542 Svortland øst
Egenskaper:

-   To felt.
-   Tidvis saktegående trafikk
-   Alle fire sløyfer har normal frekvens på ca. 85 kHz.

```{r svortlando, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_svortland_ost)
```

Vurdering:

-   Noen lave hastigheter gir bestemte feilverdier for lengde, satt av LM. Disse er utenfor vårt toleranseområde for lengde, men har ikke særlig høy qspeed.


#### Fv 862 Postterminalen
![Postterminalen](vbv_data/postterminalen.PNG)

Egenskaper:

-   Tre felt, men felt 2 er flettefelt, så sikkert en del delvise sløyfepasseringer.
-   Tidvis saktegående trafikk. Forventer en del kø i felt 1.
-   Alle sløyfer viser normal frekvens på rundt 85 kHz.

```{r postterminalen, fig.height=12, fig.width=8}
plot_all_in_one(vbv_postterminalen)
```

Ser nærmere på korte lengder.

```{r postterminalen2, fig.height=12, fig.width=8}
vbv_postterminalen %>% 
  dplyr::filter(vehicle_type == 1 | length < 2.5) %>% 
  plot_all_in_one()
```

Zoomer inn.

```{r postterminalen2_korte_zoom, fig.height=12, fig.width=8}
vbv_postterminalen %>% 
  dplyr::filter(vehicle_type == 1 | length < 2.5) %>% 
  # removing outliers
  dplyr::filter(length < 20) %>% 
  group_by(lane) %>% 
    ggplot() + 
    geom_point(aes(qspeed, length, color = vehicle_type)) +
    facet_wrap(. ~ lane, labeller = label_both) +
    geom_vline(aes(xintercept = 3)) +
    geom_hline(aes(yintercept = 2)) +
    scale_color_discrete() +
    theme_minimal()
```

Vurdering:

-   


#### Fv 6690 Elgeseter bru
Egenskaper:

-   Fire felt.
-   Tidvis saktgående trafikk.
-   Mange metrobusser på 24,5 m.
-   Sløyfefrekvenser:
    -   Felt 1 og 3: ca. 70 kHz
    -   Felt 2: 65 og 85
    -   felt 4: 85

```{r elgeseter, fig.height=12, fig.width=8}
plot_all_in_one(vbv_elgeseter)
```

Vurdering:

-   En del tilfeller at at qspeed er større enn fartsmålingen. Det må komme av at de to fartsmålingene har ulikt fortegn. Kan dette være en indikasjon på delvis sløyfepassering og/eller saktegående trafikk?


##### Data fra 24. februar 2020
Stort snøfall, ingen forventede mc, skuter o.l.

```{r elgeseter2, fig.height=12, fig.width=8}
plot_all_in_one(vbv_elgeseter_2)
```

Ser nærmere på registreringer som enten er klassifisert som MC eller har lengde under 3,5 m.

```{r elgeseter2_korte, fig.height=12, fig.width=8}
vbv_elgeseter_2 %>% 
  dplyr::filter(vehicle_type == 1 | length < 2.5) %>% 
  plot_all_in_one()
```

Zoomer inn.

```{r elgeseter2_korte_zoom, fig.height=12, fig.width=8}
vbv_elgeseter_2 %>% 
  dplyr::filter(vehicle_type == 1 | length < 2.5) %>% 
  # removing outlier
  dplyr::filter(qspeed < 20) %>% 
  group_by(lane) %>% 
    ggplot() + 
    geom_point(aes(qspeed, length, color = vehicle_type)) +
    facet_wrap(. ~ lane, labeller = label_both) +
    geom_vline(aes(xintercept = 3)) +
    geom_hline(aes(yintercept = 2)) +
    scale_color_discrete() +
    theme_minimal()
```

Vurdering:

-   


### Feltskifte
Ved felskifte akkurat over sensorene blir det delvis passering av sløyfene.


#### Ev 6 Skullerud
Egenskaper:

-   God flyt i trafikken, noe saktegående i felt 2.
-   Normal frekvens på alle sløyfer.
-   Muligens en del feltskifte.

```{r skullerud, fig.height=12, fig.width=8}
plot_all_in_one(vbv_skullerud)
```

Vurdering:

-   


# Kontroll av data fra EMU3
For EMU3 må vi ta hensyn til at ulike firmwareversjoner har hatt ulik grenseverdi for speed_quality:

- Før 25. januar 2017: qspeed-grense på 25 %, men vi brukte den ikke. Alle qspeed-verdier fra EMU3 før dette er manglende ("null"). Fra denne datoen begynte noen å få verdi.

Problem: kontrollen setter alle lengder ugyldig siden qspeed er "nøll", og den er jo nettopp det for tidligere fw-versjoner. HMmm. Er den delen av kontrollen utilsiktet? Vi har jo ikke full fw-historikk, så spørsmålet er om vi bare skal være strenge med data fra nyeste versjonene?

- Januar 2017: grensen ble endret fra 25 % til 3 % i Secondary 2.11.10, som kom et drøyt år før 1.0-versjonen for samlet firmwarepakke. Men denne inneholdt en feil som gjorde at grensen var 3 % på felt 5-8 og 25 % på felt 1-4.

- April 2018: 2.17.1 rettet feilen nevnt over slik at alle felt 1-8 fikk grense på 3 %. Den første samlede fw-pakken var 1.01, og den hadde 2.17.4. Noen tidligere varianter av usamlet fw hadde 2.17.4, men ingen andre med secondary på 2.17.x.

Det betyr at kun firmware med "*Secondary=2.17.4*" eller "*1.0x*" har hatt grensen på 3 % på alle felt.

Dagens kontroller er ikke firmwarespesfikke, men de reviderte må ta hensyn til dette.

Den første stasjonen med en EMU3 var 1500018 Flote som ble igangsatt 23. juli 2015. Her ble det byttet til LM i desember 2015. Den første stasjonen som fortsatt har EMU3 er 1500028 Valldal (like ved Trollstigen, så trafikken kan variere en god del).

Må finne ut om lengdemålingene har vært vesentlig forskjellige for de ulike fw-versjonene.


### Ev 39 Øysand
Teststrekningen har tre sløyfesett (F05, F07, F09) plassert rett etter hverandre. Dermed kan den samme trafikken sammenlignes på ulike dataloggere og firmwareversjoner.

I felt 2 på F05 har en av sløyfene lavere frekvens enn normalt, og for LM gir dette typisk noe lengre lengder enn de samme målingene i felt 2 på F07 og F09.


#### Generell fordeling av lengdemålinger
Data fra uke 23, 2021, mandag 7. juni - onsdag 9. juni:

- F05: LM 1.14.419
- F07: EMU3 1.04
- F09: LM 1.14.419

Ser på den empiriske kumulative fordelingen av lengdemålinger.

```{r gof}
#ks.test(f09$length, f07$length)
#ks.test(f05_1$length, f09_1$length)

# TODO: anderson-darling test?
```


```{r oysand_ecdf, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "mandag") %>% 
  plot_ecdf("Øysand, 7. juni 2021")
```

```{r oysand_ecdf_2, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_ecdf("Øysand, 8. juni 2021")
```


```{r oysand_ecdf_3, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "onsdag") %>% 
  plot_ecdf("Øysand, 9. juni 2021")
```

Resultatene er konsistente over disse tre dagene, og viser at EMU3 måler noe lengre lengder enn LM.

Tilsvarende kvantilplott.

```{r oysand_qq_1}
oysand_2021w23 %>%
  dplyr::filter(weekday == "mandag") %>% 
  plot_qq("Øysand, 7. juni 2021")
```

```{r oysand_qq_2}
oysand_2021w23 %>%
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_qq("Øysand, 8. juni 2021")
```

```{r oysand_qq_3}
oysand_2021w23 %>%
  dplyr::filter(weekday == "onsdag") %>% 
  plot_qq("Øysand, 9. juni 2021")
```


Sammenligner i samme plott hvordan lengdeklassifiseringen er.

```{r oysand_compare}
oysand_2021w23 %>%
  dplyr::filter(weekday == "mandag") %>% 
  ggplot(aes(qspeed, length, color = name_and_datalogger)) +
  geom_point() +
  facet_grid(rows = vars(lane)) +
  theme_minimal()
```

```{r oysand_bars_2021_06_07}
oysand_2021w23_agg_length_class_full %>% 
  dplyr::filter(weekday == "mandag") %>% 
  plot_length_class_bars(length_class_full, "Øysand, 7. juni 2021")
```

```{r oysand_bars_2021_06_08}
oysand_2021w23_agg_length_class_full %>% 
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_length_class_bars(length_class_full, "Øysand, 8. juni 2021")
```

```{r oysand_bars_2021_06_09}
oysand_2021w23_agg_length_class_full %>% 
  dplyr::filter(weekday == "onsdag") %>% 
  plot_length_class_bars(length_class_full, "Øysand, 9. juni 2021")
```

```{r oysand_bars_2_2021_06_07}
oysand_2021w23_agg_length_class_2 %>% 
  dplyr::filter(weekday == "mandag") %>% 
  plot_length_class_bars(length_class_2, "Øysand, 7. juni 2021")
```

```{r oysand_bars_2_2021_06_08}
oysand_2021w23_agg_length_class_2 %>% 
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_length_class_bars(length_class_2, "Øysand, 8. juni 2021")
```

```{r oysand_bars_2_2021_06_09}
oysand_2021w23_agg_length_class_2 %>% 
  dplyr::filter(weekday == "onsdag") %>% 
  plot_length_class_bars(length_class_2, "Øysand, 9. juni 2021")
```




```{r oysand_all_emu, fig.height=12, fig.width=8}
oysand_2021w23 %>%
  dplyr::filter(weekday == "mandag",
                name_and_datalogger == "EMU_f07") %>% 
  plot_all_in_one()
```

```{r oysand_all_lm_f09, fig.height=12, fig.width=8}
oysand_2021w23 %>%
  dplyr::filter(weekday == "mandag",
                name_and_datalogger == "LOOP_MONITOR_f09") %>% 
  plot_all_in_one()
```


### Sammenligning av kjøretøy mot kjøretøy
Med data fra 12. april 2021 er lengdemålingene sammenlignet mellom EMU3 på F05 (1.04) og LM på F09 (1.14.419).

```{r vbv_1}
plot_vbv_data(EMU3_F05, 1, "Forskjell i registrert lengde mellom EMU3 (F05) og LM (F09)")
```

```{r vbv_2}
plot_vbv_data(EMU3_F05, 2, "Forskjell i registrert lengde mellom EMU3 (F05) og LM (F09)")
```

Med data fra 27. mars 2020 er lengdemålingene sammenlignet mellom EMU3 på F07 (1.04) og LM på F09 (1.14.414).


```{r vbv_3}
plot_vbv_data(EMU3_F07, 1, "Forskjell i registrert lengde mellom EMU3 (F07) og LM (F09)")
```

```{r vbv_4}
plot_vbv_data(EMU3_F07, 2, "Forskjell i registrert lengde mellom EMU3 (F07) og LM (F09)")
```

## Samme punkt, ulik firmware


## Samme punkt, ulik datalogger


## Ulike punkt, samme firmware
Punkter som antas å ha samme trafikk


## Punkter med mange underkjente
Firefeltsveg:

-   Ev 39 Somaveien
-   Ev 39 Jåtten
-   Ev 6 Leirelva bru
-   Ev 6 Furuset N
-   Ev6 Klemetsrud

Lav lengdekvalitetsgrad i ÅDT:

-   TODO

Finn alle punkter med EMU3 i dataloggerhistorikk.

Skal vi fjerne qspeed-kontrollen fra EMU3?


## Feilsituasjoner
Forhold som forårsaker dårlig lengdemåling:

-   akselerasjon (ramper)

-   sidestilt passering av sløyfe (flerfeltsveg, sving, kryss)

-   dårlig sløyfe (unøyaktig geometri, dårlig kobling)

Typisk at ett av disse forholdene forekommer systematisk over tid for en TRP. Akselerasjon og sidestilt passering kan forekomme veldig sjelden der det ellers ikke er et problem.


# Analyse


## Loop Monitor
Her oppsummeres resultatene.

### Ulik frekvens på sløyfer
Selv om ulik frekvens på sløyfer gir høyere verdier på qspeed, ser både lengde- og fartsmålinger helt greie ut. Bruk av qspeed som indikator på lav datakvalitet er derfor ikke hensiktsmessig.


### Lav frekvens på alle sløyfer
Speed quality skiller ikke på målinger med vanlige lengder og de under 2 m eller over 27 m. Her skulle vi sett nærmere på de korte kjøretøyene og funnet ut om disse er feil eller MC.


### Klassifisering
Klare vi skille ut fakiske motorsykler? Er alle lengder under 2 m faktiske lette kjøretøy?


### Typiske lengder som blir underkjent

-   Lengder mellom 1 og 2 m forekommer relativt hyppig blant de underkjente, og fanges opp av qspeed-kontrollen. **Kan vi tro alle disse er LETTE?**
-   Øvrig lengdefordeling fra 2,5 m og oppover ligner veldig på den for godkjente lengder.


### Typiske steder med høy andel ukjente

-   Flerfeltsveg, pga. feltskifte?
-   Kø, dvs. nære kryss og trafikklys o.l.
-   Svinger, dvs. nære kryss.
-   Ramper, stor endring i fart.


#### Kø
Gir både en del lengder 1,2 - 2 m, og 20-29 m. Mange feilklassifiseres som MC.


#### Delvis passering av sløyfer
Gir stor andel 1,2 - 2 m selv med fart godt over 15 km/h.


#### Feil på sløyfe
Dersom en av to sløyfer er ødelagt (frakoblet e.l.) blir det mange 29 m.


### Sammenheng med klassifisering og fart
Foreløpige funn:

-   Det er en del lengder mellom 1 og 2 m som har underkjent klasse, men fart over 7 km/h - disse er slått ut av signalkodekontrollen.
-   Lengde 29 m gir underkjent lengde. Bør testes om klasse og fart er ok. De fleste har fart 7-15 km/h. Mange her har klasse 8, 72, 1 eller 2 - litt skeptisk til klasse.... Relativt høy andel med høy qspeed.
-   Alle med lengde under 1 m har fart under 7 km/h, så de får også underkjent fart av den kontrollen. De aller fleste her har klasse 10 eller 11.


### Revidert kontrollsett for LM
Se på klasse og lengde. Hvilke verdier hører sammen? (Fasiten på det ligger kanskje i kjøretøyregisteret?) Dersom klasse og lengde er samhørende, burde vi stole på lengden selv om qspeed sier det motsatte? Hvilken er mest til å stole på - klasse eller lengde?

Nytt kontrollsett:

-   **Fart under 7 km/h** gir underkjent fart, lengde og klasse. LM gir ikke lengde på disse, og de fleste får klasse 10 eller 11. **uendret kontroll**
-   **Lengde under 1 m** gir underkjent lengde (**ny kontroll**, de under får godkjent klasse, men de fleste er likevel ukjente).
-   **Lengde over 27 m** gir underkjent lengde (**ny kontroll**, innebærer at de utenfor får godkjent klasse - dette er en hypotese som må testes!)
-   **Signalkoden inneholder oddetall eller 0, unntatt 0202** gir underkjent klasse og lengde(?) (**ny kontroll**, hvis den også skal gjelde lengde - må testes)
-   **Klassekode 10, 11 eller tom** gir underkjent klasse (sjekk om dette er implementert slik)
-   **Qspeed over 25** gir underkjent fart og lengde (**ny kontroll**, dvs. ny grenseverdi).


## EMU3
Foreløpig forslag til revisjon:

-   qspeed = *null* skrotes (var aldri ment å skulle gjelde?). Vil føre til at "alle" lengder fra fw tidligere enn de nevnt nedenfor blir godkjent. Må verifiseres at dette er rimelig.

-   qspeed-kontroll gjelder kun for fw med konsistent verdi for qspeed (s2.17.4 og 1.0x)


# Konklusjon

Etter å ha sett på mye data i Kibana (visualisering "Ukjent lengde histogram"), viser det seg at kontrollene som underkjenner lengdemålingene fordeler seg som følger.

LM:

  - Fart under 7 km/h (får ingen lengde av LM): noen få utslag av denne kontrollen.
  - Lengde utenfor (1, 27) m: noen få utslag av denne kontrollen.
  - **Qspeed større enn 3: de fleste utslagene skyldes denne kontrollen.**

EMU3:

  - Fart under 7 km/h:
    <p style="color:red">TODO</p>

  - Lengde utenfor (1, 27) m:
    <p style="color:red">TODO</p>

  - Speed_quality ≠ 0:
    <p style="color:red">TODO</p>

## LM
Resultatene av denne undersøkelsen viser at vi må justere enkelte kontroller. Det er kontrollene som benytter qspeed vi må endre, dvs. øke grenseverdien får når qspeed fører til underkjent lengde og klassifisering. Da vil vi i mye større grad vise fram data som har god nok datakvalitet til lengde- og kjøretøyklassifisering enn det vi gjør i dag.

Enkelte situasjoner fører til for lav kvalitet på lengdemålingene og disse bør i størst mulig grad fanges opp av kvalitetskontrollene. Dette gjelder i hovedsak der hvor det er kø, delvis passeringer eller feil på sløyfer.


## EMU3
[Analyse pågår.]
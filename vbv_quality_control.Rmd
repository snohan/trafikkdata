---
title: "Analyse av kvalitetskontroller for enkeltkjøretøyregistreringer"
output: 
  html_notebook:
    theme: cerulean
    number_sections: true
    toc: true
    toc_float: 
      collapsed: false
      smooth_scroll: false
    toc_depth: 2
---

```{r setup, message=F, include=FALSE}
library(tidyverse)
library(knitr)
library(cowplot) # may be replaced by patchwork here?
#library(patchwork)
library(lubridate)
library(rmarkdown)
library(RColorBrewer)

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  cache = TRUE,
  dev = "ragg_png"
  )
```


# Bakgrunn
Når trafikkdatasystemet mottar data om en kjøretøyregistrering fra et trafikkregistreringspunkt, lagres dette i først *rådatabasen*. Etter at ryddegutt har sjekket at alle data er overført for en klokketime, sendes alle data gjennom en kvalitetskontroll og lagres i databasen for *kontrollerte data*.

Kvalitetskontrollene gjøres fordi data som kommer inn ikke alltid er gode nok til sitt formål. Kontrollene ble først utarbeidet i samråd med dataloggerleverandørene, samt basert på Statens vegvesens testing. Til testingen ble fasiten laget på grunnlag av manuell gjennomgang av videoopptak kombinert med kjøretøyopplysninger fra Kjøretøyregisteret.

Kvalitetskontrollene deles inn i to sett, og gjelder for enten

  - alle dataloggertyper, eller
  - hver spesifikk dataloggertype (og eventuelt firmwareversjon).
  
Hensikten med kontrollene er å merke data som har for lav kvalitet. Utgangspunktet er at alle data er av god nok kvalitet dersom de ikke faller utenfor krav som stilles i kontrollene. 
  
I dette dokumentet er det kun data fra registreringer av motorkjøretøy som er omtalt. Det omfatter kun to dataloggertyper: Loop Monitor (LM) og EMU3.


## Kontroller som gjelder alle dataloggertyper
Uansett hvilken dataloggertype data kommer fra, så gjelder følgende:

  - **Selve registreringen er ugyldig dersom**:
    - Kjørefeltverdien er fraværende.
    - Kjørefeltverdien er utenfor de kjørefeltene som eksisterer på trafikkregistreringspunktet.
    - Løpenummer mangler.
    - Lengdeverdien mangler.

  - **Lengde og klassifisering er ugyldig dersom**:
    - Lengde er \< 1 m eller \> 27 m.
    - Lengdeverdien mangler.
    
  - **Klassifisering er ugyldig dersom**:
    - Klassifiseringen mangler.

  - **Fart er ugyldig dersom**:
    - Absoluttverdi av fart \> 300 km/h.


## Dataloggerspesifikke kontroller
For **LM** gjelder følgende:

  - **Fart, lengde og klassifisering er ugyldig dersom**:
    - Absoluttverdi av fart \< 7 km/h. (LM angir ingen lengde når farten er så lav.)

  - **Fart og lengde er ugyldig dersom**:
    - Fartsulikhet* \>= 25 % for fart \>= 100 km/h, eller \>= 25 km/h for fart \< 100 km/h. (Endret i mars 2020 fra 3 % / 3 km/h.)
    - Fartsulikhetsverdien mangler.
    - Fartsverdien mangler.

 - **Klassifisering er ugyldig dersom**:
    - Signalkoden inneholder oddetall eller 0, unntatt 0202.
    - Signalkoden mangler.
    
\*Fartsulikhet fra LM er det absolutte avviket (i km/h) mellom sløyfe 1 og 2.

For **EMU3** gjelder følgende:

  - **Fart og lengde er ugyldig dersom**:
    - Absoluttverdi av fart \< 7 km/h.
    - Fartsverdien mangler.

  - **Fart, lengde og klassifisering er ugyldig dersom**:
    - Fartsulikhet\*\* ≠ 0 (omsatt fra "Change of speed validity bit" satt til TRUE). 
    - Fartsulikhetsverdien mangler.

\*\*Fartsulikhet for EMU3 er basert på absolutt avvik i fart mellom de to sløyfene, men er omgjort til en boolsk parameter ved en angitt grenseverdi som er hardkodet i firmware.


## Analysens formål
Noen trafikkregistreringspunkter har høy andel underkjente lengdemålinger. Er dette reellt eller er kontrollene for strenge? Hva er grunnen til at lengdemålingene blir underkjente? Målet med analysen er å finne ut hvor godt kontrollene treffer og eventuelt justere dem. Om kontrollene justeres, skal alle data i Trafikkdatasystemet reberegnes tilbake til 2014.

Denne analysen tar ikke for seg deteksjonsgraden av antall kjøretøy, men er konsentrert om måleverdiene for lengde og klassifisering som tilhører de faktisk registrerte kjøretøyene. Fartsverdien er også til dels med i analysen, men siden den faktiske fartsverdien er ukjent, blir denne størrelsen behandlet med stor grad av skjønn.


# Metode
Analysen gjennomføres ved å se på et representativt utvalg data fra Trafikkdatasystemet. Måleverdier for enkeltkjøretøy analyseres for hvert kjørefelt, og data fra et trafikkregistreringspunkt sammenlignes over tid. Det ses på ulike situasjoner som forårsaker feil i data. Aggregerte data for lengde- og kjøretøyklasse sammenlignes.


## Feilsituasjoner
Ved god flyt i trafikken, god kvalitet på sløyfene og ingen delvise sløyfepasseringer blir datakvaliteten veldig god, også for lengdemålingene. Dette er blant annet dokumentert i Statens vegvesens tester på Øysand testtrekning. Likevel kan det forekomme tilfeldig målefeil, men det antas at dette forekommer sjeldent.

Lavere datakvalitet oppstår av ulike årsaker som grovt kan deles inn i tre kategorier:

  - Feil på sløyfer:
    - betydelig ulik frekvens på sløyfer i samme felt
    - frekvens utenfor toleranseområde
    - elektronisk støy (kan være årsak til de to førstnevnte)
    - ingen frekvens (sløyfebrudd, ikke tilkoblet sløyfe eller dårlig koblet sløyfe, kortslutning)
    - sløyfene lagt med feil dimensjon (systematisk feilkilde)
  - Delvis passering av sløyfer
  - Saktegående eller stillestående trafikk
  - Høy akselerasjon (høy fartsulikhet)
  
De ulike feilsituasjonene kan gi opphav til ekstreme måleverdier som avslører lav datakvalitet:

  - Lengde utenfor (1, 27) m
  - Fart under 7 km/h
  - Høy fart for lange kjøretøy
  - Fartsulikhet
    - over 3 for LM
    - ulik 0 for EMU3
    
Måleverdier som er innenfor grenseverdiene kan også være feil, men det er vanskeligere å avsløre. Denne analysen fokuserer på å finne de grenseverdiene som best passer våre krav til datakvalitet.


## Framgangsmåte
For å gjennomføre analysen, gjøres følgende:

  - Finn punkt med høy andel underkjente lengder.
  - Beskriv stedlige forhold:
    - antall felt
    - fartsnivå
    - sløyfestatus
    - trafikale forhold
  - Sannsynliggjør årsak til feil.
  - Se på et utvalg av data for ett kjørefelt og finn eventuelle sammenhenger mellom lengde, klasse, fart og fartsulikhet.
  - Vurder om kontrollene er fornuftige.
  
  
## Delanalyser
Relevante problemstillinger:

  - Hvilke kontroller underkjenner lengder?
  - Er det sammenheng i kvaliteten på kjøretøyklasse og lengde?
  - Er det sammenheng i kvaliteten på fart og lengde?
  - Lengde utenfor (1, 27) m: lengde og klasse ok?
  - Fartsulikhet over 3 eller ulik 0: lengde og klasse ok?
  - Forskjell i frekvens på \> 20 kHz - lengde og klasse ok?
  

# Analyse av data fra LM
Denne analysedelen ble gjennomført i februar 2020. Endret kontrollsett for LM ble implementert da og alle tidligere data ble reberegnet innen april 2020.

I det følgende er det sett på data fra 20. februar 2020, om ikke annet er oppgitt.


## Punkter med lav datakvalitet
Liste over trafikkregistreringspunkter som har flest tilfeller innenfor de angitte, spesielle måleverdiene:

  - **lengde under 1 m**
    - Moholtlia, fire felt: har sløyfefeil.
    - Kannik, fire felt: kø? Gjelder felt 2 og 4.
    - Drengsrud ved Liahagen, fire felt: Gjelder spesielt felt 3.
    - Hansjordnestunnelen: kryss og kø. I felt 2 og 4.
    - Høvik, fire felt: felt 1 (liten andel).

  - **lengde mellom 1 og 2 m**
    - E10 Moskenes arm til ferge: kø?, felt 1 (høy andel).
    - Gansås: ukjent årsak.
    - Postterminalen: kryss, kø.
    - Grillstadtunnelen vest, fire felt: feltskifte?
    - Puddefjordsbroen ved Laksevåg: sving, kryss, kø.

  - **lengde over 29 m**
    - Drengsrud ved Liahagen, fire felt: felt 3.
    - Sundland, fire felt: feltskifte og/eller sløyfefeil.
    - Høvik, fire felt: felt 1 (liten andel).
    - Moholtlia, fire felt: sløyfefeil.
    - E10 Moskenes arm til ferge: kø? (høy andel).

  - **fart under 7 km/h**
    -  Kannik, fire felt: kø? i felt 2 og 4.
    -  Moholtlia, fire felt: sløyfefeil.
    -  Drengsrud ved Liahagen, fire felt: felt 3.
    -  Hansjordnestunnelen: kryss, kø, felt 2 og 4.
    -  Høvik, fire felt: felt 1 (liten andel).

  - **fartsulikhet over 3**
    - Skullerud hovedkjørefelt, firefelt.
    - Taraldrud, firefelt.
    - Smihagen enveg med, firefelt.
    - Sundland, firefelt.
    - Kroppan bru, firefelt.

Punkter med kø, ugunstig sensorplassering eller dårlige sløyfer

  - 54688V625212 Skullerud hovedkjørefelt (feltskifte?)
  - 14354V2486023 Hålogalandsbrua (sløyfefeil, støy?)
  - 68557V444232 Blommenholm (feltskifte?)
  - 06970V72811 Kroppan bru (dårlige sløyfer i motretning)
  - 94949V444217 Smihagen enveg med (feltskifte?)
  - 68234V443152 Taraldrud (feltskifte felt 4?)
  - 48379V625405 St. Ringvei Nydalsbrua (feltskifte?)
  - 68351V319882 Kannik (sløyfefeil)
  - 00000V1993681 Ytrebygdveien (feltskifte?)

Andre punkter med høy andel underkjente lengder:

-   Årøytunnelen, Søyland, Klinga, Sønsterud, Eggetunnelen, Reinsvoll, Asker og sikkert flere, ingen godkjente i ene feltet pga fartsulikhet, som nok skyldes 20 kHz forskjell på sløyfene der.
-   Vassbotn brua, veldig ulik frekvens på flere sløyfer, mye fartsulikhet 10-15


## Sløyfer med ulik frekvens
Dagens kontrollsett gir ukjent lengde for de fleste passeringer i felt der det er stor forskjell i frekvensen på de to sløyfene. Typisk eksempel er der hvor en sløyfe har omkring 65 kHz og den andre ligger rundt 85 kHz. Sistnevnte er normalt frekvensnivå.

Hva som er grunnen til at en sløyfe har omtrent 20 kHz lavere frekvens enn normalt, er ukjent.


### Ev 18 Asker
Egenskaper:

  - Fire felt
  - Fart mellom 60 og 120 km/h
  - En sløyfe i felt 3 har 20 kHz lavere enn de andre sløyfene
  - God flyt i trafikken

```{r asker, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_asker)
```

Vurdering:

  - Ulik frekvens på sløyfene i det ene feltet gir høyere fartsulikhet-verdier her, men både lengde- og fartsmålinger, samt klassifisering, synes ikke å avvike fra felt med normal frekvens.


### Fv 44 Søyland
Egenskaper:

  - To felt
  - Fart mellom 50 og 90 km/h
  - En sløyfe i felt 2 har 20 kHz lavere enn de andre sløyfene
  - Grei flyt i trafikken 
  
```{r soyland, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_soyland)
```

Vurdering:

  - Ulik frekvens på sløyfene i det ene feltet gir høyere fartsulikhet-verdier her, men både lengde- og fartsmålinger, samt klassifisering, synes ikke å avvike fra felt med normal frekvens.
  
  
### Ev 39 Øysand F05
På teststasjon F05 har vi tilfellet med ulik frekvens på sløyfene i felt 2. Frekvensen ligger på omkring 65 og 85 kHz. Felt 2 har stort sett fartsulikhet over 3 og dermed underkjente lengdemålinger.

Egenskaper:

  - To felt
  - Fart på rundt 80 km/h
  - En sløyfe i felt 2 har 20 kHz lavere enn de andre sløyfene
  - Stort sett god flyt i trafikken

```{r f05, fig.height=12, fig.width=8}
plot_all_in_one(vbv_f05)
```

Vurdering:

  - Ulik frekvens på sløyfene i det ene feltet gir høyere fartsulikhet-verdier her, men både lengde- og fartsmålinger, samt klassifisering, synes ikke å avvike fra felt med normal frekvens.


## Lav frekvens på alle sløyfer
Noen punkter har jevnt lav frekvens på alle sløyfene, men likevel innenfor oppgitt toleranseområde.


### Fv 5004 Hollundsvegen
Egenskaper:

  - To felt
  - 0 - 60 km/h
  - Alle fire sløyfer har frekvens på ca. 55 kHz
  - Tidvis saktegående trafikk
  
```{r hollundsvegen, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_hollundsvegen)
```

Vurdering:

  - Mange kjøretøy får lengde under 2 m og noen får 29 m, men fartsulikhet er ingen god indikator på dette.
  - Skulle sett nærmere på lengdene mellom 1 og 2 m. Mange av disse er klassifisert som motorsykkel, men er det riktig?
  

### Fv 542 Svortland vest
Egenskaper:

  - To felt
  - 10 - 100 km/h
  - Alle fire sløyfer har frekvens på ca. 65 kHz
  - Tidvis saktegående trafikk

```{r svortlandv, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_svortland_vest)
```

Vurdering:

  - Mange kjøretøy får lengde under 2 m og noen får 29 m, men speed quality er ingen god indikator på dette.
  - Skulle sett nærmere på lengdene mellom 1 og 2 m.
  - Noen lange kjøretøy har veldig høy fart, noe som skal være umulig.
  

## Brudd eller dårlig koblet sløyfe


### Ev 6 Moholtlia
Egenskaper:

  - Fire felt
  - 10 - 75 km/h
  - Stort sett god flyt i trafikken
  - Feil på en av sløyfene i felt 4, ellers frekvenser rundt 70 kHz

```{r moholtlia, fig.height=12, fig.width=8}
plot_all_in_one(vbv_moholtlia)
```

Vurdering:

  - I felt 4 får de fleste kjøretøy omtrent maksimal fartsulikhet, dvs. at den ene fartsmålingen er nær null.
  - Mange av lengdemålingene får en bestemt maksimal- eller minimumsverdi av LM, som er utenfor vårt godkjenningsintervall.
  - Fartsulikhet og ekstrem lengde ser her ut til å være en god indiaktor på lav datakvalitet for lengde og klassifisering.
  - En del lange kjøretøy har fart over 100 km/h, som sikkert er feil verdi. Det er lite trolig at felt 4 skal ha så mange med høy fart som ikke er tilfelle i felt 1-3. Det gjør det opplagt at farten er feil, men hvor feil er lengden da?


## Saktegående trafikk


### Fv 542 Svortland øst
Egenskaper:

  - To felt
  - 0 - 75 km/h
  - Tidvis saktegående trafikk
  - Alle fire sløyfer har normal frekvens på ca. 85 kHz

```{r svortlando, fig.height=12, fig.width=8}
plot_all_in_one(vbv_data_svortland_ost)
```

Vurdering:

  - Noen lave hastigheter gir bestemte feilverdier for lengde, satt av LM. Disse er utenfor vårt toleranseområde for lengde, men har ikke særlig høy fartsulikhet.


### Fv 862 Postterminalen
![Punktet Postterminalen er markert med gult.](vbv_data/postterminalen.png)

Egenskaper:

  - Tre felt, men felt 2 er flettefelt, med en stor andel delvise sløyfepasseringer.
  - Tidvis saktegående trafikk. Forventer en del kø i felt 1.
  - Alle sløyfer viser normal frekvens på rundt 85 kHz.

```{r postterminalen, fig.height=12, fig.width=8}
plot_all_in_one(vbv_postterminalen)
```

Ser nærmere på korte lengder.

```{r postterminalen2, fig.height=12, fig.width=8}
vbv_postterminalen %>% 
  dplyr::filter(vehicle_type == 1 | length < 2.5) %>%
  plot_all_in_one()
```

Vurdering:

  - I felt 2 er det ikke lavt fartsnivå, men høy andel delvise passeringer. Mange kjøretøy blir her klassifisert som motorsykkel, men det er nok stort avvik fra virkeligheten. Det er likevel god overensstemmelse mellom lengde og klassifisering, selv om en del kjøretøy får angitt standarlengde. En del kjøretøy har større fartsulikhet, men det er ikke noe klart skille.
  - I felt 1 og 3 er det både lav fart og delvise sløyfepasseringer. Spesielt i felt 1 ser det ut som om lengdene er noe lengre enn vanlig. Det går heller ikke her noe klart skille på fartsulikhet.


### Fv 6690 Elgeseter bru
Egenskaper:

  - Fire felt.
  - Tidvis saktgående trafikk.
  - Mange metrobusser på 24,5 m.
  - Sløyfefrekvenser:
    - felt 1 og 3: ca. 70 kHz
    - felt 2: 65 og 85
    - felt 4: 85

```{r elgeseter, fig.height=12, fig.width=8}
plot_all_in_one(vbv_elgeseter)
```

Vurdering:

-   En del tilfeller at at fartsulikhet er større enn fartsmålingen. Det må komme av at de to fartsmålingene har ulikt fortegn. Kan dette være en indikasjon på delvis sløyfepassering og/eller saktegående trafikk?


#### Data fra 24. februar 2020
Stort snøfall, ingen forventede mc, skuter o.l.

```{r elgeseter2, fig.height=12, fig.width=8}
plot_all_in_one(vbv_elgeseter_2)
```

Ser nærmere på registreringer som enten er klassifisert som motorsykkel eller har lengde under 3,5 m.

```{r elgeseter2_korte, fig.height=12, fig.width=8}
vbv_elgeseter_2 %>% 
  dplyr::filter(vehicle_type == 1 | length < 2.5) %>% 
  plot_all_in_one()
```

Vurdering:

  - Føreforhold tilsier at det ikke skal være noen motorsykler, men likevel er mange klassifisert som nettopp det. Det antas at dette skyldes feltskifte med delvise sløyfepasseringer. De har heller ikke lav fart.
  - Hverken lengde eller fartsulikhet gir et tydelig skille på korrekt klassifisering.


## Feltskifte
Ved felskifte akkurat over sensorene blir det delvis passering av sløyfene.


### Ev 6 Skullerud
Egenskaper:

  - God flyt i trafikken, noe saktegående i felt 2.
  - Normal frekvens på alle sløyfer.
  - Muligens en del feltskifte.

```{r skullerud, fig.height=12, fig.width=8}
plot_all_in_one(vbv_skullerud)
```

Vurdering:

  - Noen ganske lange kjøretøy har veldig høy fart i felt 4. Dette virker lite troverdig. Det skyldes kanskje delvis passering. Her ser fartsulikhet til å være en god indikator på det. 
  - Noen lange kjøretøy har usannsynlig høy fart.


## Rv 706 Havnegata og Rotvollekra
Begge disse trafikkregistreringspunktene har fire felt, med ÅDT på henholdsvis 20 000 og 30 000. På Havnegata er det tidvis saktegående trafikk, mens på Rotvollekra er det god flyt med fartsnivå rundt 70 km/h. Felles for disse to punktene er forekomsten av feltskifte akkurat der hvor sløyfene ligger.

Hele 1. desember 2021 var det en del snøfall gjennom hele døgnet. Derfor er det ikke forventet en eneste motorsykkel i datagrunnlaget, men likevel er det ganske mange forkomster. Dette skyldes feltskifte og det typiske er at ett reellt kjøretøy blir registrert som to. Som oftest får begge korte lengder, hvorav ett nesten alltid blir feilaktig klassifisert som motorsykkel.


# Analyse av data fra EMU3
For EMU3 må det eventuelt tas hensyn til at ulike firmwareversjoner har hatt ulik grenseverdi for fartsulikhet:

- Før 25. januar 2017: fartsulikhetsgrensen var programmert til 25 % i firmware, men den ble ikke benyttet til kontroll. Alle fartsulikhetsverdier fra EMU3 før dette er manglende ("null"). Fra denne datoen ble de første EMU3 oppgradert til ny firmwareversjon og de første punktene begynte å få verdi.

Problemstilling: kontrollen setter alle lengder ugyldig når fartsulikhet er manglende, og den er jo nettopp det for tidligere fw-versjoner. Når alle data for et punkt reberegnes, vil alle lengder fra denne første tiden settes som ugyldig, og det blir jo feil. Dagens kontroller er ikke firmwarespesfikke, men de reviderte må eventuelt ta hensyn til dette.

- Januar 2017: grensen ble endret fra 25 % til 3 % i Secondary 2.11.10. Denne kom et drøyt år før 1.0-versjonen for samlet firmwarepakke. Men denne inneholdt en feil som gjorde at grensen var 3 % på felt 5-8 og 25 % på felt 1-4.

- April 2018: 2.17.1 rettet feilen nevnt over slik at alle felt 1-8 fikk grense på 3 %. Den første samlede fw-pakken var 1.01, og den hadde 2.17.4. Noen tidligere varianter av usamlet fw hadde 2.17.4, men ingen andre med secondary på 2.17.x. Det betyr at kun firmware med "*Secondary=2.17.4*" eller "*1.0x*" har hatt grensen på 3 % på alle felt. Og det er først da kontrollen kan være konsistent.


## Punkter med normale forhold
Mange punkter har normale trafikkforhold som ikke byr på utfordringer for trafikkregistreringsutstyret og data blir av god kvalitet. 


### Fv 770 Finnevatnet
Egenskaper:

  - Landlig tofeltsveg
  - Fartsnivå 50 - 90 km/h
  - Normal frekvens på alle sløyfer

```{r finnevatnet, fig.height=12, fig.width=8}
plot_all_in_one(vbv_finnevatnet)
```

Vurdering:

  - Ganske like data fra begge felt.
  - Noen har fartsulikhet forskjellig fra null, men fordeling på lengde og klasse ser lik ut uansett.
  - Er et typisk bilde på data fra punkt med normale trafikkforhold.
  
  
## Sløyfer med ulik frekvens
Det er noen tilfeller hvor sløyfene i samme felt har forskjell i frekvens på omkring 20 kHz. Det er ukjent hva dette kan skyldes, men det kan påvirke datakvaliteten.


### Fv 6432 Kyrksæterøra

Egenskaper: 

  - To felt
  - Fartsnivå 20 - 50 km/h
  - Forskjellig frekvens på sløyfene i felt 1 på omkring 20 kHz
  
```{r kyrkseterora, fig.height=12, fig.width=8}
plot_all_in_one(vbv_kyrkseterora)
```
  
Vurdering:

  - Data ser like ut fra begge felt.
  - Data ser normale ut.
  

### Ev 39 Tastatorget

Egenskaper: 

  - To felt, adskilt med dobbel sperrelinje.
  - Omtrent 20 kHz i forskjell i begge felt.
  - Tidvis lav fart i felt 2.
  
```{r tastatorget, fig.height=12, fig.width=8}
plot_all_in_one(vbv_tastatorget)
```

Vurdering:

  - Lav fart i felt 2. Her er også andel tunge høy, 20 % på mandag, og 14 % på søndag.
  - Felt 1 har grei fart. Andel tunge på 10 % på mandag og 6 % på søndag.
  - Lav datakvalitet skyldes heller lav fart enn forskjellig frekvens.
  

## Lav frekvens på alle sløyfer
EMU3 har to ulike sløyfekort, høyfrekvent og lavfrekvent. Det kan likevel hende at alle sløyfer har lavere frekvensnivå enn normalt.


### Fv 60 Stranda
Egenskaper:

  - To felt.
  - Lav frekvens (70 kHz) på alle sløyfer.
  - Fart på 20 - 100 km/h

```{r stranda, fig.height=12, fig.width=8}
plot_all_in_one(vbv_stranda)
```

Vurdering:
  
  - Trafikkdata ser likt ut for begge felt.
  - Data skiller seg ikke åpenbart fra normale forhold med god datakvalitet.
  
  
## Saktegående trafikk

### Fv 1758 Strandgata
Egenskaper:

  - To felt
  - 10 - 60 km/h
  - Tidvis saktegående trafikk
  - Alle fire sløyfer har litt høy frekvens på ca. 100 kHz

```{r strandgata, fig.height=12, fig.width=8}
plot_all_in_one(vbv_strandgata)
```

Vurdering:

  - Høy andel fartsulikhet forskjellig fra 0, men det er ingen god indikasjon på lav datakvalitet.
  - En del kjøretøy som blir målt til under 1 m. Fartsulikhet er ingen god indikator på disse.
  - Noen tilfeller av negativ fartsulikhet.
  - Andel tunge stabilt rundt 3 %.
  
  
### Fv 484 Festningsgata (Kristiansand)

Egenskaper:

  - Fem felt.
  - Mye saktegående trafikk, spesielt i felt 1 og 3.
  
```{r festningsgata, fig.height=12, fig.width=8}
plot_all_in_one(vbv_festningsgata)
```

Vurdering:

  - Ser ut til at lange kjøretøy ikke kan få lav fart!
  - En del lengder under 2 m.
  - Stor andel fartsulikhet forskjellig fra null, men det er ingen god indikator på lav datakvalitet.
  - Andel tunge rundt 15 %.
  - Noen lange kjøretøy har usannsynlig høy fart.
  

### Fv 283 Øvre Sund bru

Egenskaper:

  - Fire felt.
  - Nært kryss, mye lav fart i felt 1 og 3.
  - Kan være en del feltskifte i felt 2 og 4.
  - Grei frekvens på alle sløyfer.
  
```{r ovre_sund_bru, fig.height=12, fig.width=8}
plot_all_in_one(vbv_ovre_sund_bru)
```
  
Vurdering:

  - Felt 1 og 3 har andel tunge på 7,7 %, mens felt 2 og 4 har 5,2 %.
  - Noen korte kjøretøy i alle felt.
  - Andel tunge er på samme nivå i begge retninger.
  - Noen lange kjøretøy har usannsynlig høy fart.
  
  
## Feltskifte

### Ev39 Somaveien
Egenskaper:

  - Fire felt.
  - 40 - 140 km/h.
  - Tidvis noe saktere trafikk, men ikke stillestående.
  - Antar noe feltskifte.
  
  
```{r soma, fig.height=12, fig.width=8}
plot_all_in_one(vbv_somaveien)
```

Vurdering:

  - Greit fartsnivå. En del tilfeller med positiv fartsulikhet forskjellig fra 0, men dette synes ikke å være noen god indikator på lav datakvalitet.
  - Noen lange kjøretøy har usannsynlig høy fart.


### Fv 6690 Holtermannsvegen
Dette trafikkregistreringspunktet har seks felt, med ÅDT på omkring 20 000. Det er tidvis saktegående trafikk. Det er en liten forekomst av feltskifte akkurat der hvor sløyfene ligger. I felt 6 er sløyfene plassert akkurat ved et hyppig brukt busstopp.

Hele 1. desember 2021 var det en del snøfall gjennom hele døgnet. Derfor er det ikke forventet en eneste motorsykkel i datagrunnlaget, men likevel er det noen forkomster. Dette skyldes nok hovedsaklig feltskifte eller saktegående trafikk. Det typiske er at ett reellt kjøretøy blir registrert som to, og som oftest får begge korte lengder, hvorav ett nesten alltid blir feilaktig klassifisert som motorsykkel.

I felt 6 er det relativt lite trafikk og det er nesten kun busser. Her er det større problem med stoppende busser enn feltskifte. Det er observert buss som stoppet på sløyfene og som ikke ble registrert. Det er en del registreringer med lav fart.


# Rv 706 Havnegata
På Havnegata er det en del feltskifte ovr sløyfene. I tilfeller studert med videoopptak er det ikke funnet noen duplikater, men enkelte får for kort lengde. I ett enkelt tilfelle ble det observert en personbil med sann lengde omkring 4 m som fikk målt lengde på 1,9 m og feilklassifisert som motorsykkel.


## Samme punkt, ulik firmware
En hypotese er at lengdemålingene har vært vesentlig forskjellige for de ulike fw-versjonene.


### Ev 6 Berkåk
2. oktober 2018 ble firmware oppgradert fra Primary=5.3.4/Secondary=2.15.0/1.89 til 1.02. Sammenligner her data fra mandag-onsdag i uka før og to uker etter dette (uungår høstferien).

Egenskaper:

  - To felt.
  - Fart 20 - 80 km/h.
  
Først data fra 24.-26. september 2018.

```{r berkaak_emu_gml_fw, fig.height=12, fig.width=8}
plot_all_in_one(vbv_berkaak_emu_gml_fw)
```
  
Siden grensen for å sette fartsulikhet forskjellig fra null var på 25 %, var det ganske få tilfeller av dette her.

Så til 15.-17. oktober 2018 med nyere firmware:

```{r berkaak_emu_ny_fw, fig.height=12, fig.width=8}
plot_all_in_one(vbv_berkaak_emu_ny_fw)
```

Siden grensen for å sette fartsulikhet forskjellig fra null var på 3 %, var det ganske mange flere tilfeller av dette her.

Det er ingen åpenbare forkjeller i kvaliteten på dataene før og etter firmwareoppgraderingen.

Videre sammenlignes andel tunge kjøretøy før og etter oppgradering av firmware.

Først med lengde som grunnlag.

```{r berkaak_fw_hr_length, fig.height=4, fig.width=8}
berkaak_fw_hr_by_length %>% 
  plot_heavy_ratio()
```

Så med klasse som grunnlag.

```{r berkaak_fw_hr_class, fig.height=4, fig.width=8}
berkaak_fw_hr_by_class %>% 
  plot_heavy_ratio()
```

Tendensen er klart at den nyere firmwaren hadde så vidt litt høyere andel tunge kjøretøy. Dette kan likevel skyldes at trafikken var annerledes.


## Samme punkt, ulik datalogger
Ser om måleverdiene har endret seg ved bytte av datalogger på samme sløyfer.


### Ev 6 Berkåk

Egenskaper:

  - To felt.
  - Fart 20 - 80 km/h. (Nære Stavåbrua som hadde redusert fart)
  
Først data fra 6.-8. januar 2020 med EMU3.
  
```{r berkaak_emu, fig.height=12, fig.width=8}
plot_all_in_one(vbv_berkaak_emu)
```

Data fra LM:
```{r berkaak_lm, fig.height=12, fig.width=8}
plot_all_in_one(vbv_berkaak_lm)
```

Vurdering: 

  - I januar er det neppe noen relle motorsykler her. De få som er klassifisert som motorsykler eller har fått kort lengde, kan komme av lav fart eller sentrisk kjøring.

Videre sammenlignes andel tunge kjøretøy før og etter bytte av datalogger på Berkåk. For EMU3 er data hentet fra 6. - 8. januar 2020 og for LM er det 20. - 22. januar 2020.

Først med lengde som grunnlag.

```{r berkaak_hr_length, fig.height=4, fig.width=8}
berkaak_hr_by_length %>% 
  plot_heavy_ratio()
```

Så med kjøretøyklasse som grunnlag.

```{r berkaak_hr_class, fig.height=4, fig.width=8}
berkaak_hr_by_class %>% 
  plot_heavy_ratio()
```

Siden data er fra ulike uker, kan andel tunge avvike noe. Men her er det rimelig likt nivå disse tre dagene. Andlene basert på klasse ligger jevnt over noe lavere enn de basert på lengde, men forskjellen mellom dataloggerne er omtrent den samme.


### Ev 39 Brekktunnelen

Egenskaper:

  - To felt.
  - Fart mellom 50 og 100 km/h.
  
Data fra EMU3:

```{r brekktunnelen_emu, fig.height=12, fig.width=8}
plot_all_in_one(vbv_brekktunnelen_emu)
```

Data fra LM:

```{r brekktunnelen_lm, fig.height=12, fig.width=8}
plot_all_in_one(vbv_brekktunnelen_lm)
```

Videre sammenlignes andel tunge kjøretøy før og etter bytte av datalogger på Berkåk. For EMU3 er data hentet fra 27. - 29. januar 2020 og for LM er det 10. - 12. januar 2020.

Først med lengde som grunnlag.

```{r brekktunnelen_hr_length, fig.height=4, fig.width=8}
brekktunnelen_hr_by_length %>% 
  plot_heavy_ratio()
```

Så med klasse som grunnlag.

```{r brekktunnelen_hr_class, fig.height=4, fig.width=8}
brekktunnelen_hr_by_class %>% 
  plot_heavy_ratio()
```

Vurdering:

  - Andel tunge er veldig lik mellom EMU3 og LM. 
  
  
# Sammenligning av LM og EMU3
Teststrekningen på Ev 39 ved Øysand har tre sløyfesett (F05, F07, F09) plassert rett etter hverandre. Dermed kan den samme trafikken sammenlignes på ulike dataloggere og firmwareversjoner.

I felt 2 på F05 har en av sløyfene lavere frekvens enn normalt, og fra tidligere testing er det kjent at LM typisk gir noe lengre lengder enn de samme målingene i felt 2 på F07 og F09.


## Generell fordeling av lengdemålinger
Analyse av data fra uke 23, 2021, mandag 7. juni - onsdag 9. juni. Følgende oppsett for sløyfesett, datalogger og firmware:

- F05: LM 1.14.419
- F07: EMU3 1.04
- F09: LM 1.14.419

Ser på den empiriske kumulative fordelingen av lengdemålinger.

```{r gof}
#ks.test(f09$length, f07$length)
#ks.test(f05_1$length, f09_1$length)

# TODO: anderson-darling test?
```


```{r oysand_ecdf, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "mandag") %>% 
  plot_ecdf("Øysand, 7. juni 2021")
```

```{r oysand_ecdf_2, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_ecdf("Øysand, 8. juni 2021")
```


```{r oysand_ecdf_3, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "onsdag") %>% 
  plot_ecdf("Øysand, 9. juni 2021")
```

Resultatene er konsistente over disse tre dagene, og viser at EMU3 måler noe lengre lengder enn LM i felt 1. I felt 2 måler LM noe lengre lengder, men dette skyldes nok at den ene sløyfa der er litt dårlig.

Det er verdt å merke at kurvenes stigningstall øker brått ved omkring 4 m og avtar markant ved omkring 6 m, noe som viser at de fleste kjøretøy er mellom 4 m og 6 m lange.

Ser på tilsvarende kvantilplott.

```{r oysand_qq_1, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "mandag") %>% 
  plot_qq("Øysand, 7. juni 2021")
```

```{r oysand_qq_2, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_qq("Øysand, 8. juni 2021")
```

```{r oysand_qq_3, fig.height=7, fig.width=6}
oysand_2021w23 %>%
  dplyr::filter(weekday == "onsdag") %>% 
  plot_qq("Øysand, 9. juni 2021")
```

Også her vises klart at LM på F05 har lengre lengder i felt 2. Ellers er det ganske likt.


## Lengde- og kjøretøyklassifisering
Hvordan påvirkes lengdeklassifiseringen av at dataloggerne har litt ulike lengder?


```{r oysand_bars_2021_06_07}
oysand_2021w23_agg_length_class_full %>% 
  dplyr::filter(weekday == "mandag") %>% 
  plot_length_class_bars(length_class_full, "Øysand, 7. juni 2021")
```

```{r oysand_bars_2021_06_08}
oysand_2021w23_agg_length_class_full %>% 
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_length_class_bars(length_class_full, "Øysand, 8. juni 2021")
```

```{r oysand_bars_2021_06_09}
oysand_2021w23_agg_length_class_full %>% 
  dplyr::filter(weekday == "onsdag") %>% 
  plot_length_class_bars(length_class_full, "Øysand, 9. juni 2021")
```

```{r oysand_bars_2_2021_06_07}
oysand_2021w23_agg_length_class_2 %>% 
  dplyr::filter(weekday == "mandag") %>% 
  plot_length_class_bars(length_class_2, "Øysand, 7. juni 2021")
```

```{r oysand_bars_2_2021_06_08}
oysand_2021w23_agg_length_class_2 %>% 
  dplyr::filter(weekday == "tirsdag") %>% 
  plot_length_class_bars(length_class_2, "Øysand, 8. juni 2021")
```

```{r oysand_bars_2_2021_06_09}
oysand_2021w23_agg_length_class_2 %>% 
  dplyr::filter(weekday == "onsdag") %>% 
  plot_length_class_bars(length_class_2, "Øysand, 9. juni 2021")
```

Sammenligner andel tunge basert på lengdemålinger.

```{r heavy_ratio, fig.height=4, fig.width=8}
plot_heavy_ratio(oysand_2021w23_agg_length_class_2_heavy_ratio)
```

Sammenligner andel tunge basert på klassifisering.

```{r heavy_ratio_nl2, fig.height=4, fig.width=8}
plot_heavy_ratio(oysand_2021w23_nl2_hr)
```

Tendensen er at EMU3 har større andel tunge kjøretøy. Det er også her tydelig hvordan feilen på den ene sløyfa på F05 gir større andel i felt 2.



## Sammenligning av flere måleverdier
Ser på data fra tre dager i juni og sammenligner per felt.

```{r oysand_compare_1, fig.height=12, fig.width=8}
oysand_2021w23 %>%
  dplyr::filter(lane_number == "felt 1") %>%
  plot_all_in_one()
```


```{r oysand_compare_2, fig.height=12, fig.width=8}
oysand_2021w23 %>%
  dplyr::filter(lane_number == "felt 2") %>%
  plot_all_in_one()
```

Grovt sett er det veldig likt. Fartsulikhet virker ikke å være noen god indikator på data med lav kvalitet verken for EMU3 eller LM.


## Sammenligning av kjøretøy mot kjøretøy
I tre tilfeller er det gjort matching av kjøretøy mot kjøretøy mellom data fra to punkter på Øysand. Dette er gjort for å sammenligne måleverdier fra det samme kjøretøyet fra ulike dataloggere og sløyfesett.


### EMU3 på F05
Med data fra 12. april 2021 er lengdemålingene sammenlignet mellom EMU3 på F05 (1.04) og LM på F09 (1.14.419). Det er kjent at den ene sløyfa i felt 2 på F05 har omkring 20 kHz lavere frekvens enn normalt.

```{r vbv_f05_1}
plot_vbv_data(EMU3_F05, 1, "Forskjell i registrert lengde mellom EMU3 (F05) og LM (F09)")
```

```{r vbv_f05_2}
plot_vbv_data(EMU3_F05, 2, "Forskjell i registrert lengde mellom EMU3 (F05) og LM (F09)")
```

Også for EMU3 blir det lengre lengder i felt 2 på F05. De som har underkjent lengde hos EMU3 her kommer for det meste av at fartsulikhetsverdien er ulik 0, men fordelingen av lengder ser ikke ut til å være vesentlig forskjellig likevel.

I figuren under sammenlignes andel tunge basert på lengdemålinger.

```{r EMU3_F05_length_hr, fig.height=4, fig.width=8}
plot_heavy_ratio(EMU3_F05_length_hr)
```

Andelen tunge er veldig lik i felt 1, men i felt 2 er den nesten dobbelt så stor og dette skyldes nok feilen på den ene sløyfa her.

I figuren under sammenlignes andel tunge basert på kjøretøyklassifisering.

```{r EMU3_F05_class_hr, fig.height=4, fig.width=8}
plot_heavy_ratio(EMU3_F05_class_hr)
```

Her framgår det at tungbilandelen i felt 2 er mer lik når klassifisering benyttes som grunnlag.

Figurene under viser en nærmere titt på kjøretøy som klassifiseres ulikt av de to dataloggerne. Først de som er målt kortere enn 5,6 m av LM, men lengre enn 5,6 m av EMU3.

```{r EMU3_F05_diff_length_class_longer, fig.height=4, fig.width=8}
plot_different_length_classes(EMU3_F05_different_length_class_longer,
                              "EMU3 F05 og LM F09")
```

Her kommer det tydelig fram at det er flere tilfeller av ulik lengdeklassifisering i felt 2 enn i felt 1. Det kommer også ganske tydelig fram at EMU3 ved en høy andel tilfeller skiller mellom lette og tunge kjøretøy ved 6 m. Det er veldig få som er målt kortere enn 5,6 m av LM og samtidig klassifisert som tung av LM.

I figuren under vises kjøretøy målt kortere enn 5,6 m av EMU3, men lenger enn 5,6 m av LM.

```{r EMU3_F05_diff_length_class_shorter, fig.height=4, fig.width=8}
plot_different_length_classes(EMU3_F05_different_length_class_shorter,
                              "EMU3 F05 og LM F09")
```

Ingen kjøretøy målt kortere enn 5,6 m av EMU3 er klassifisert som tunge av EMU3. Ut fra forrige figur ser dette ut til å gjelde opp til 6 m. En god del av kjøretøyene målt mellom 5,6 m og 6 m er klassifisert som lette av LM. Det ser her ut som om også LM har et skille ved 6 m mellom klassene lette og tunge, men skillet er noe mindre skarpt enn hos EMU3.

Det er ingen kjøretøy i dette utvalget som er målt under 4 m av noen av dataloggerne.

Figuren nedenfor viser lengdemålinger under 3 m.

```{r EMU3_F05_under_#, fig.height=4, fig.width=8}
plot_different_length_classes(EMU3_F05_under_3,
                              "EMU3 F05 og LM F09")
```

Selv om det er en del avvik på lengdemålingene, er begge datalogger enige om at disse er lette.


### EMU3 på F07
Med data fra 27. mars 2020 er lengdemålingene sammenlignet mellom EMU3 på F07 (1.04) og LM på F09 (1.14.414).

```{r vbv_3}
plot_vbv_data(EMU3_F07, 1, "Forskjell i registrert lengde mellom EMU3 (F07) og LM (F09)")
```

```{r vbv_4}
plot_vbv_data(EMU3_F07, 2, "Forskjell i registrert lengde mellom EMU3 (F07) og LM (F09)")
```

Det er gjennomgående litt avvik på lengdemålingene til de to dataloggerne. Fartsulikhet, som fører til underkjent lengde, gir ikke noe tydelig skille på hvor like (gode) lengdemålingene er.

I figuren under sammenlignes andel tunge basert på lengdemålingene.

```{r EMU3_F07_length_hr, fig.height=4, fig.width=8}
plot_heavy_ratio(EMU3_F07_length_hr)
```

EMU3 har klart større tungbilandel i begge felt her.

I figuren under sammenlignes andel tunge basert på klassifisering.

```{r EMU3_F07_class_hr, fig.height=4, fig.width=8}
plot_heavy_ratio(EMU3_F07_class_hr)
```

Tungbilandelen er litt mer lik når klassifisering benyttes som grunnlag, men fortsatt har EMU3 høyere andel i begge felt.

Figurene under viser en nærmere titt på kjøretøy som klassifiseres ulikt av de to dataloggerne. Først de som er målt kortere enn 5,6 m av LM, men lengre enn 5,6 m av EMU3.

```{r EMU3_F07_diff_length_class_longer, fig.height=4, fig.width=8}
plot_different_length_classes(EMU3_F07_different_length_class_longer,
                              "EMU3 F07 og LM F09")
```
Her er situasjonen ganske lik i begge felt, og her er alle sløyfenes frekvenser på samme nivå. Det går også her fram at EMU3 har et skille ved 6 m der det skilles på lette og tunge klasser. LM har her ingen i klassen for lette. Et par kjøretøy er målt veldig mye lengre av EMU3 enn LM, og i ett av disse tilfellene skyldes dette at EMU3 har slått sammen fire kortere kjøretøy som kjørte nære hverandre. I det andre tilfellet er det et par motorsykler som har kjørt forbi andre kjøretøy og det kan ha lurt EMU3 til å tolke oppdeling av kjøretøy noe feil.

Det er kun ett kjøretøy i dette utvalget som er målt under 4 m av en av dataloggerne.

I figuren under vises kjøretøy målt kortere enn 5,6 m av EMU3, men lenger enn 5,6 m av LM.

```{r EMU3_F07_diff_length_class_shorter, fig.height=4, fig.width=8}
plot_different_length_classes(EMU3_F07_different_length_class_shorter,
                              "EMU3 F07 og LM F09")
```

Situasjonen er veldig lik i begge feltene. Det er et mindre antall kjøretøy som av LM er målt lengre enn 5,6 m og kortere enn 5,6 m av EMU3. LM sitt skille mellom klassene lette og tunge er her også rundt 6 m, men også noen betydelig lengre kjøretøy er klassifisert som lette av LM.

EMU3 har her ingen i klassen tunge.

Figuren under viser målinger under 3 m.

```{r EMU3_F07_under_3, fig.height=4, fig.width=8}
plot_different_length_classes(EMU3_F07_under_3,
                              "EMU3 F07 og LM F09")
```

Begge dataloggere er enige om klassifiseringen av disse korte kjøretøyene.


### EMU3 på F09
Med data fra 30. august 2021 er lengdemålingene sammenlignet mellom EMU3 på F09 (1.04) og LM på F07 (1.14.419).

```{r vbv_f09_1}
plot_vbv_data(EMU3_F09, 1, "Forskjell i registrert lengde mellom EMU3 (F09) og LM (F07)")
```

```{r vbv_f09_2}
plot_vbv_data(EMU3_F09, 2, "Forskjell i registrert lengde mellom EMU3 (F09) og LM (F07)")
```

Det er gjennomgående litt avvik på lengdemålingene til de to dataloggerne. Fartsulikhet, som fører til underkjent lengde, gir ikke noe tydelig skille på hvor like (gode) lengdemålingene er.

I figuren under sammenlignes andel tunge basert på lengdemålingene.

```{r EMU3_F09_length_hr, fig.height=4, fig.width=8}
plot_heavy_ratio(EMU3_F09_length_hr)
```

EMU3 har klart større tungbilandel i begge felt her, men mest i felt 2.

I figuren under sammenlignes andel tunge basert på klassifisering.

```{r EMU3_F09_class_hr, fig.height=4, fig.width=8}
plot_heavy_ratio(EMU3_F09_class_hr)
```

Tungbilandelen er litt mer lik når klassifisering benyttes som grunnlag, men fortsatt har EMU3 høyere andel i begge felt.

Figurene under viser en nærmere titt på kjøretøy som klassifiseres ulikt av de to dataloggerne. Først de som er målt kortere enn 5,6 m av LM, men lengre enn 5,6 m av EMU3.

```{r EMU3_F09_diff_length_class_longer, fig.height=4, fig.width=8}
plot_different_length_classes(EMU3_F09_different_length_class_longer,
                              "EMU3 F09 og LM F07")
```

Her er situasjonen ganske lik i begge felt. Det er noen tilfeller der EMU3 har målt veldig mye lengre lengder enn LM. I to tilfeller har to eller tre kjøretøy kjørt tett på hverandre, og LM og EMU3 har tolket dette ulikt. I et annet tilfelle har EMU3 slått sammen to kjøretøy til ett.

I figuren under vises kjøretøy målt kortere enn 5,6 m av EMU3, men lenger enn 5,6 m av LM.

```{r EMU3_F09_diff_length_class_shorter, fig.height=4, fig.width=8}
plot_different_length_classes(EMU3_F09_different_length_class_shorter,
                              "EMU3 F09 og LM F07")
```

Situasjonen er veldig lik i begge feltene. Det er et mindre antall kjøretøy som av LM er målt lengre enn 5,6 m og kortere enn 5,6 m av EMU3. LM sitt skille mellom klassene lette og tunge er her også rundt 6 m, men også noen betydelig lengre kjøretøy er klassifisert som lette av LM.

EMU3 har her ingen i klassen tunge.

Figuren under viser målinger under 3 m.

```{r EMU3_F09_under_3, fig.height=4, fig.width=8}
plot_different_length_classes(EMU3_F09_under_3,
                              "EMU3 F09 og LM F07")
```

Begge dataloggere er enige om klassifiseringen av disse korte kjøretøyene, bortsett fra i ett tilfelle.


# Oppsummering og konklusjon
Her er en oppsummering av analysene og forslag til endring av kvalitetskontrollene.


## Klassifisering av motorsykler
Det virker vanskelig å klassifisere motorsykler korrekt. Fra før vet vi at mange motorsykler unnslipper sløyfene ved å plassere seg for langt ut i kanten av kjørefeltet. I tillegg oppstår det mange falske motorsykler ved feltskifte og lav fart. En vurdering av om klassifisering av motorsykler er god nok må gjøres for hvert trafikkregistreringspunkt.


## Klassifisering basert på lengde eller klasse
Oppsummert fra analysen:

  - Både LM og EMU3 virker tilsynelatende å ha et skille rundt 6 m mellom lette og tunge klasser.
  - Fordi det finnes færre kjøretøy rundt 6 m enn rundt 5,6 m, blir dermed andel tunge lavere basert på klasse enn lengde.
  - Selv om tendensen er at EMU3, og LM på sløyfer med ulik frekvens, måler lengre lengder enn reellt, så slår ikke dette like mye ut over 6 m som mellom 5,6-6 m, og dermed blir klassifisering basert på klasse likere enn basert på lengde.


## Høy fart på tunge kjøretøy
I Kjøretøyforskriften står det at alle (med visse unntak) tunge kjøretøy skal ha fartssperre på 90 eller 100 km/h. En kontroll som sjekker sammenhengen mellom fart og lengde vil luke vekk en del opplagte feil på fart dersom vi kan anta at lengden er noenlunde korrekt. For å være litt sikker på at ikke gode data underkjennes kan kontrollen være at fart over 110 km/h på kjøretøy som er klassifisert som tunge underkjennes.

Dette blir da en ny kontroll som gjelder alle dataloggertyper for motorkjøretøy.


## Feltskifte
Sentrisk kjøring er når et kjøretøy passerer mellom to felt og passerer kun delvis sløyfene i det ene eller begge feltene. På tofeltsveg skal dette være håndtert av dataloggerne. Men på veger med to eller flere felt i samme retning kan det oppstå sentrisk kjøring ved feltskifte. Noen steder er det mange tilfeller av dette.

Problemer som følger av at et kjøretøy passerer delvis over to sløyfepar er:

- Ett kjøretøy kan bli registrert som to
- Lengdemålingen kan bli feil uten at kontrollene fanger det opp
- Klassen kan bli feil uten at kontrollene fanger det opp

Der kjøretøy skifter felt over sløyfene vil det i mange tilfeller bli målt for kort lengde og gitt feil klasse, typisk vil dette føre til falske motorsykler. Det vil i mange tilfeller også oppstå duplikater hvor minst en av registreringene er veldig korte.

Det synes vanskelig å unngå og filtrere vekk reelle kjøretøy samtidig som rene duplikater fjernes. Et trenet menneskelig øye kan se forskjell på en del tilfeller når informasjon om føreforhold tas med i betraktningen, som når vi kan være sikre på at ingen motorsykler kjører i tett snøvær. 

Det vil også en sjelden gang være en reell motorsykkel som passerer over sløyfene i sitt felt samtidig med en bil i det nærmeste feltet. Forekomsten av falske motorsykler fra feltskifte er likevel mye større, slik at et filter som fjerner de fleste falske, men også et fåtall reelle kan forsvares. 

Et duplikatfilter kan derfor lete etter alle passeringspar i nærliggende kjørefelt i samme retning, som har passeringstidspunkt innenfor 0,5 s. Kriteriet for at det er et duplikat er at minst ett av registreringene har lengde på 2,0 m eller kortere. Da kan den registreringen som har lavest kvalitet settes som en ikke-godkjent registrering. Typisk vil de med klassen motorsykkel være lite troverdig i denne sammenheng, men begge kan ha fått denne klassen.


## Saktegående trafikk
Ved saktegående trafikk vil lengdemålingene bli veldig usikre. Når kjøretøy står stille på sløyfene og det påfølgende kjøretøy kommer veldig tett på, kan det oppstå sammenslåing av registreringer. For eksempel kan to personbiler bli tolket som ett langt kjøretøy både i form av lengde og klasse. Noe slike sammenslåtte registreringer ser ut som et autentisk langt kjøretøy, men noen får lengde over 27 m og/eller ukjent klasse.


## Konklusjon for felles kontroller
Kontrollene som gjelder uansett dataloggertype, bør justeres til følgende (endringer er angitt i parentes):

  - **Selve registreringen er ugyldig dersom**:
    - Kjørefeltverdien er fraværende.
    - Kjørefeltverdien er utenfor de kjørefeltene som eksisterer på trafikkregistreringspunktet.
    - Løpenummer mangler.
    - Lengdeverdien mangler.

  - **Lengde og klassifisering er ugyldig dersom**:
    - Lengdeverdien mangler.
    - Lengde er \< 1 m eller \> 27 m.
    
  - **Klassifisering er ugyldig dersom**:
    - Klassifiseringen mangler.
    
  - **Fart er ugyldig dersom**:
    - Absoluttverdi av fart \> 300 km/h.
    - Absoluttverdi av fart \> 110 km/h og lengden er \> 7,6 m. *(lagt til)*
    

## Oppsummering for LM
Kontrollene som underkjenner lengdemålingene fordeler seg som følger:

  - Fart under 7 km/h (får ingen lengde av LM): noen få utslag av denne kontrollen.
  - Lengde utenfor (1, 27) m: noen få utslag av denne kontrollen.
  - Fartsulikhet større enn 3: de fleste utslagene skyldes denne kontrollen.
  - Det er en del lengder mellom 1 og 2 m som har underkjent klasse, men fart over 7 km/h - disse er slått ut av signalkodekontrollen.
  
LM benytter følgende standardverdier for enkelte kjøretøyregistreringer:

  -	Manglende lengde: settes når farten er under 7 km/h.
  -	1,2 m: minimumslengde på signal som blir tolket som motorsykkel, men har usikker lengde pga. ikke-perfekt signalforløp.
  -	1,95 m: minimumslengde på signal som blir tolket som personbil, men har usikker lengde pga. ikke-perfekt signalforløp.
  -	29 m: maksimumslengde på signal som blir tolket som personbil, men har usikker lengde pga. ikke-perfekt signalforløp. Denne kan også inntreffe dersom lastebil passerer med en personbil liggende tett bak.

**Ulik frekvens på sløyfer**: Selv om ulik frekvens på sløyfer gir høyere verdier på fartsulikhet, ser både lengde- og fartsmålinger helt greie ut. På Øysand ser det ut til at lengdene blir noe lengre, men ikke av særlig betydning. 

Bruk av fartsulikhet som indikator på lav datakvalitet er ikke hensiktsmessig i dette tilfellet.

**Lav frekvens på alle sløyfer**: Lav frekvens på alle sløyfer gir mange korte lengder. Fartsulikhet skiller ikke på målinger med vanlige lengder og de under 2 m eller over 27 m. En nærmere undersøkelse av de korte kjøretøyene bør gjennomføres for å sjekke om klassifiseringen er god.

Bruk av fartsulikhet som indikator på lav datakvalitet er ikke hensiktsmessig i dette tilfellet.

**Feil på sløyfe**: Dersom en av to sløyfer i samme kjørefelt er ødelagt (frakoblet e.l.) blir det mange lengder på 29 m.

Lengder utenfor (1, 27) m, høy fartsulikhet og kombinasjonen høy fart for lange kjøretøy er gode indikatorer på data med lav kvalitet i dette tilfellet.

**Kø**: Gir både en del lengder 1,2-2 m, og 20-29 m. Mange feilklassifiseres som motorsykkel.

Lengder utenfor (1, 27) m er en god indikator på lav datakvalitet i dette tilfellet.

**Delvis passering av sløyfer**: Gir stor andel 1,2-2 m selv med fart godt over 15 km/h. Mange feilklassifiseres som motorsykkel.

Lengder utenfor (1, 27) m, høy fartsulikhet og kombinasjonen høy fart for lange kjøretøy er gode indikatorer på data med lav kvalitet i dette tilfellet.


## Konklusjon for LM
Resultatene av denne undersøkelsen viser at vi må justere enkelte kontroller. I kontrollene som benytter fartsulikhet må grenseverdien økes får når fartsulikhet fører til underkjent lengde og klassifisering.

Observasjoner i denne analysen:

  - **Fart under 7 km/h** gir underkjent fart, lengde og klasse. LM gir ikke lengde på disse, og de fleste får klasse 10 eller 11. Uendret kontroll.
  - **Lengde under 1 m** gir underkjent lengde, og de fleste får ukjent klasse.
  - **Lengde over 27 m** gir underkjent lengde, men kan de få godkjent klasse? Dette må testes!
  - **Klassekode 10, 11 eller tom** gir underkjent klasse. 10 er ikke med i dagens kode!
  - **Fartsulikhet over 25** gir underkjent fart og lengde. Endret kontroll våren 2020, dvs. ny grenseverdi.

Forslag til nytt kontrollsett (endringer angitt i parentes):

  - **Fart, lengde og klassifisering er ugyldig dersom**:
    - Absoluttverdi av fart \< 7 km/h.

  - **Fart og lengde er ugyldig dersom**:
    - Fartsulikhet* \>= 25 % for fart \>= 100 km/h, eller \>= 25 km/h for fart \< 100 km/h. (Endret i mars 2020 fra 3 % / 3 km/h.)
    - Fartsulikhetsverdien mangler.
    - Fartsverdien mangler.

 - **Klassifisering er ugyldig dersom**:
    - Signalkoden inneholder oddetall eller 0, unntatt 0202.
    - Signalkoden mangler.
    - Klassen er 10, 11 eller tom. *(lagt til)*


## Oppsummering for EMU3
EMU3 bruker noen standardverdier for enkelte kjøretøyregistreringer:

  -	1,25 m: minimumslengde for kjøretøy generelt. Usikre lengdemålinger som blir kortere, får automatisk satt lengden til 1,25 m. De fleste klassifiseres som motorsykkel, men også noen biler får denne lengden. Opptrer typisk i forbindelse med delvis passering.

**Ulik frekvens på sløyfer**: Bruk av fartsulikhet som indikator på lav datakvalitet er ikke hensiktsmessig i dette tilfellet.

**Lav frekvens på alle sløyfer**: Bruk av fartsulikhet som indikator på lav datakvalitet er ikke hensiktsmessig i dette tilfellet.

**Kø**: Gir en del lengder 1-2 m. Mange feilklassifiseres som motorsykkel. Lengder utenfor (1, 27) m er en god indikator på lav datakvalitet i dette tilfellet.

**Delvis passering av sløyfer**: Gir stor andel 1-2 m selv med fart godt over 15 km/h. Mange feilklassifiseres som motorsykkel. Lengder utenfor (1, 27) m, høy fartsulikhet og kombinasjonen høy fart for lange kjøretøy er gode indikatorer på data med lav kvalitet i dette tilfellet.

**Fartsulikhet mangler**: Det finnes noen tilfeller i rådatabasen der fartsulikhetsverdien mangler. Da er alltid fart og lengde maks verdi på datatypen (2^16-1), og disse fanges opp av andre regler. Men klassifiseringen er en fornuftig verdi.


## Konklusjon for EMU3
Forslag til nytt kontrollsett (endringer angitt i parentes):

  - **Fart og lengde er ugyldig dersom**:
    - Absoluttverdi av fart \< 7 km/h.
    - Fartsverdien mangler.
    
  - **Klassifisering er ugyldig dersom**:
    - Klassen er ikke en av LMV1, LMV2, HMV, LMV2+WC, HMV+WC. *(lagt til)* 

  - *(Fartsulikhetskontroller er fjernet)*


## Gjenstående analyser
Gjenstående analyser:

  - Hva er korrekt klassifisering av kjøretøy som får målt lengde under 2 m? Er alle disse lette kjøretøy?
  - Lengde over 27 m gir underkjent lengde. Bør testes om klasse og fart er ok. De fleste har fart 7-15 km/h. Mange her har klasse 8, 72, 1 eller 2 - litt skeptisk til klasse.... Relativt høy andel med høy fartsulikhet.
  - Finn ut om signalkodekontrollen til LM skal slå ut på lengde også.
  - Er det mulig å avdekke sensorproblemer ut fra fordeling av lengdeverdier?
  - Bruke data fra mange punkter til å finne normal fordeling av lengder rundt 5,6 m, f.eks. (3, 7,6). Hvordan ser denne ut dersom alle forhold ellers er ok? (Fart, feltskifte, sløyfer)
  - Hvilken tungbilandel er mest korrekt - den basert på lengde eller klassifisering?
  - Hva sier kjøretøyregisteret om sammenhengen mellom lengde og klasseskillet mellom lette og tunge?
  - Hvor god er klassifiseringen av hengere? Spesielt lette kjøretøy med henger - blir disse tolket som tunge?
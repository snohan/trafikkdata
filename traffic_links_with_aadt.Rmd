---
title: "Predikert ÅDT"
output: html_notebook
---

```{r setup, include = FALSE, echo = FALSE}
library(tidyverse)
library(leaflet)
library(sf)
library(knitr)
library(htmltools)

source("H:/Programmering/R/byindeks/get_from_nvdb_api.R")
source("H:/Programmering/R/byindeks/get_from_trafficdata_api.R")
source("H:/Programmering/R/byindeks/split_road_system_reference.R")

# knitr options ####
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      cache = FALSE)

# Map essentials ####
nvdb_map_url <-
  "https://nvdbcache.geodataonline.no/arcgis/rest/services/Trafikkportalen/GeocacheTrafikkJPG/MapServer/tile/{z}/{y}/{x}"

nvdb_map_attribution <-
  "NVDB, Geovekst, kommunene og Open Street Map contributors (utenfor Norge)"

nvdb_crs <- leafletCRS(
  crsClass = "L.Proj.CRS", code = "EPSG:25833",
  proj4def = "+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs",
  resolutions = c(
    21674.7100160867,
    10837.35500804335,
    5418.677504021675,
    2709.3387520108377,
    1354.6693760054188,
    677.3346880027094,
    338.6673440013547,
    169.33367200067735,
    84.66683600033868,
    42.33341800016934,
    21.16670900008467,
    10.583354500042335,
    5.291677250021167,
    2.6458386250105836,
    1.3229193125052918,
    0.6614596562526459,
    0.33072982812632296,
    0.16536491406316148
  ),
  origin = c(-2500000.0, 9045984.0))
```

```{r file_path, include=FALSE}
geopackage_file <- "trafikklenker/steg2_AADT_ALL_EV_RV_2020.gpkg"
#layers <- sf::st_layers(geopackage_file)
```

```{r explore_rows, message=FALSE, include=FALSE}
link_query <- "SELECT * FROM \"edges\""
#top_row_query <- "SELECT feature_oid, start_node_oid, end_node_oid FROM \"TrafikkLenker\" WHERE geometry IS NOT NULL LIMIT 15"
#link_query <- "SELECT * FROM \"TrafikkLenker\" WHERE start_node_oid IN(3283021)"
links_selected <- sf::st_read(geopackage_file, "edges",
                                      as_tibble = TRUE,
                                      query = link_query)

links_selected_id <- links_selected %>% 
  dplyr::select(ID) %>% 
  dplyr::distinct()
```

```{r transform_geometry}
traffic_links_wide <- links_selected %>%
  dplyr::select(ID,
                roadcat = ROADREF_CATEGORY,
                roadn = ROADREF_NUMBER,
                with = med_metrering,
                pred_aadt,
                sd = pred_aadt_sd,
                nettaadt_mangler
                ) %>% 
  sf::st_drop_geometry() %>% 
  tidyr::pivot_wider(
    names_from = with,
    names_prefix = "med_",
    values_from = c(pred_aadt, sd, nettaadt_mangler)
  ) %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(
    aadt = sum(pred_aadt_med_0, pred_aadt_med_1, na.rm = TRUE),
    sd = dplyr::case_when(
      # if one or both directions are missing
      is.na(pred_aadt_med_1) || is.na(pred_aadt_med_0) ~ 
        sum(sd_med_1, sd_med_0, na.rm = TRUE),
      # when both is present, combined sd
      TRUE ~ sqrt((sd_med_1^2 + sd_med_0^2)/2 + 
        ((pred_aadt_med_1 - pred_aadt_med_0)/2)^2)
    )
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    across(
      .cols = c(pred_aadt_med_1, pred_aadt_med_0,
                sd_med_1, sd_med_0,
                aadt, sd),
      ~ round(.x)
    )
  )

traffic_links_transformed <- links_selected_id %>% 
  dplyr::left_join(traffic_links_wide, by = "ID") %>% 
  sf::st_zm(drop = T, what = "ZM") %>% 
  dplyr::mutate(line_length = round(sf::st_length(geom),
                                    digits = 0)) %>% 
  dplyr::mutate(
    link_label = paste("ÅDT ", aadt, "S: ", sd, "<br/>",
                       "Med ", pred_aadt_med_1, "S: ", sd_med_1, 
                       "TM-ÅDT: ", nettaadt_mangler_med_1,  "<br/>",
                       "Mot ", pred_aadt_med_0, "S: ", sd_med_0, 
                       "TM-ÅDT: ", nettaadt_mangler_med_0,"<br/>",
                       line_length, " m"),
    link_label = lapply(link_label, htmltools::HTML)) %>% 
  sf::st_transform("+proj=longlat +datum=WGS84")

# TODO: compare to manual aadt
```

```{r compare}
# Try Rv 15
manual_adt <- get_aadt_by_road("RV15")

rv15 <- traffic_links_transformed %>% 
  dplyr::filter(roadn == 15)


sf::st_intersects()
```



Sammenligning mellom predikert ÅDT fra Norsk Regnesentrals modell og manuell ÅDT-belegging.

```{r map_links}
leaflet(width = "100%",
        height = 700,
        options = leafletOptions(crs = nvdb_crs,
                                 zoomControl = F)) %>%
  addTiles(urlTemplate = nvdb_map_url,
           attribution = nvdb_map_attribution) %>%
  addPolylines(data = traffic_links_transformed,
               popup = ~link_label,
               highlightOptions = highlightOptions(bringToFront = TRUE,
                                                   sendToBack = FALSE,
                                                   color = "red",
                                                   opacity = 0.6))
```

```{r trp}
# TODO: show trps
```


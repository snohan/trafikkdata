---
title: "Trafikklenker"
output: html_notebook
---


```{r setup, include = FALSE, echo = FALSE}
# Packages ####
library(tidyverse)
library(leaflet)
library(sf)
library(knitr)
library(flextable)
library(htmltools)

# knitr options ####
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      cache = FALSE)

# Map essentials ####
nvdb_map_url <-
  "https://nvdbcache.geodataonline.no/arcgis/rest/services/Trafikkportalen/GeocacheTrafikkJPG/MapServer/tile/{z}/{y}/{x}"

nvdb_map_attribution <-
  "NVDB, Geovekst, kommunene og Open Street Map contributors (utenfor Norge)"

nvdb_crs <- leafletCRS(
  crsClass = "L.Proj.CRS", code = "EPSG:25833",
  proj4def = "+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs",
  resolutions = c(
    21674.7100160867,
    10837.35500804335,
    5418.677504021675,
    2709.3387520108377,
    1354.6693760054188,
    677.3346880027094,
    338.6673440013547,
    169.33367200067735,
    84.66683600033868,
    42.33341800016934,
    21.16670900008467,
    10.583354500042335,
    5.291677250021167,
    2.6458386250105836,
    1.3229193125052918,
    0.6614596562526459,
    0.33072982812632296,
    0.16536491406316148
  ),
  origin = c(-2500000.0, 9045984.0))

```

```{r read_data}
geopackage_file <- "trafikklenker_20200601150729.gpkg"

#sf::st_layers(geopackage_file)

top_row_query <- "SELECT * FROM \"Trafikklenker\" LIMIT 100"

e39_query <- "SELECT * FROM \"Trafikklenker\" WHERE ELEMENT_ID = 384479"

trafikklenker_top <- sf::st_read(geopackage_file, "Trafikklenker",
                             as_tibble = TRUE,
                             query = top_row_query)

trafikklenker_e39 <- sf::st_read(geopackage_file, "Trafikklenker",
                             as_tibble = TRUE,
                             query = e39_query)



#str(trafikklenker_top)
#sf::st_crs(trafikklenker_top)
#sf::st_set_crs(trafikklenker_top, "+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs")

trafikklenker_top_sorted <- trafikklenker_top %>%
  arrange(START_NODE_OID) %>%
  st_zm(drop = T, what = "ZM") %>% 
  select(GEOMETRY) %>% 
  #slice(1:10) %>% 
  mutate(line_length = sf::st_length(GEOMETRY))

#str(trafikklenker_top_sorted)
#sf::st_crs(trafikklenker_top_sorted)

trafikklenker_top_sorted_wgs84 <- sf::st_transform(trafikklenker_top_sorted,
                                                   "+proj=longlat +datum=WGS84")

#sf::st_crs(trafikklenker_top_sorted_wgs84)


trafikklenker_e39_clean <- trafikklenker_e39 %>%
  #arrange(START_NODE_OID) %>%
  st_zm(drop = T, what = "ZM") %>% 
  select(GEOMETRY) %>% 
  #slice(1:10) %>% 
  mutate(line_length = sf::st_length(GEOMETRY)) %>% 
  sf::st_transform("+proj=longlat +datum=WGS84")
```



```{r plot}
# trafikklenker_top_sorted %>%
#   ggplot() +
#   geom_sf()

leaflet(width = "100%",
          height = 700,
          options = leafletOptions(crs = nvdb_crs,
                                   zoomControl = F)) %>%
  addTiles(urlTemplate = nvdb_map_url,
           attribution = nvdb_map_attribution) %>%
  addPolylines(data = trafikklenker_e39_clean,
               popup = ~htmlEscape(line_length),
               highlightOptions = highlightOptions(bringToFront = TRUE,
                                                   sendToBack = TRUE,
                                                   color = "white",
                                                   opacity = 0.7)) 
```

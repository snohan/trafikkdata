---
title: "Trafikklenker"
output: html_notebook
---

```{r setup, include = FALSE, echo = FALSE}
# Packages ####
library(tidyverse)
library(leaflet)
library(sf)
library(knitr)
library(flextable)
library(htmltools)

source("H:/Programmering/R/byindeks/get_from_nvdb_api.R")

# knitr options ####
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      cache = FALSE)

# Map essentials ####
nvdb_map_url <-
  "https://nvdbcache.geodataonline.no/arcgis/rest/services/Trafikkportalen/GeocacheTrafikkJPG/MapServer/tile/{z}/{y}/{x}"

nvdb_map_attribution <-
  "NVDB, Geovekst, kommunene og Open Street Map contributors (utenfor Norge)"

nvdb_crs <- leafletCRS(
  crsClass = "L.Proj.CRS", code = "EPSG:25833",
  proj4def = "+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs",
  resolutions = c(
    21674.7100160867,
    10837.35500804335,
    5418.677504021675,
    2709.3387520108377,
    1354.6693760054188,
    677.3346880027094,
    338.6673440013547,
    169.33367200067735,
    84.66683600033868,
    42.33341800016934,
    21.16670900008467,
    10.583354500042335,
    5.291677250021167,
    2.6458386250105836,
    1.3229193125052918,
    0.6614596562526459,
    0.33072982812632296,
    0.16536491406316148
  ),
  origin = c(-2500000.0, 9045984.0))

alle_kommuner <- hent_alle_kommuner_v3()
```

```{r read_data, message=FALSE, include=FALSE}
geopackage_file <- "trafikklenker_20200713002654.gpkg"

# To see layers in gpkg file
#sf::st_layers(geopackage_file)

# Exploring the top rows
# top_row_query <- "SELECT * FROM \"Trafikklenker\" LIMIT 100"
# trafikklenker_top <- sf::st_read(geopackage_file, "Trafikklenker",
#                              as_tibble = TRUE,
#                              query = top_row_query)

#top_row_query <- "SELECT * FROM \"Kryss\" LIMIT 100"
#kryss_top <- sf::st_read(geopackage_file, "Kryss",
#                              as_tibble = TRUE,
#                              query = top_row_query)


# Looking at a specific road segment
# E39 Førde: 384479
# Harsjøen: IN (705126, 705125) 
#element_query <- "SELECT * FROM \"Trafikklenker\" WHERE ELEMENT_ID BETWEEN 705100 AND 705200"
#element_query <- "SELECT * FROM \"Trafikklenker\" WHERE ELEMENT_ID IN (705126, 705125, 705238, 705127)"
# Klett
element_query <- "SELECT * FROM \"Trafikklenker\" WHERE ELEMENT_ID IN (3112188, 3112207, 2997535, 2997537, 2997540, 2997539, 3112180, 3112181, 2997528, 2997531, 3112190, 3112189, 2997529, 3112179, 72241, 72242, 2801072)"

# Read many
#element_query <- "SELECT feature_oid, start_node_oid, end_node_oid, geometry FROM \"Trafikklenker\" LIMIT 50000;"
#element_query <- "SELECT * FROM \"Trafikklenker\" LIMIT 5;"

# TODO: query by road number (via NVDB API to find all element IDs belonging to road number)

trafikklenker_element <- sf::st_read(geopackage_file, "Trafikklenker",
                                     as_tibble = TRUE,
                                     query = element_query)
```

```{r intersections}
# Tilhørende kryss
# TODO: find just outer intersections of combined links
# unique_start_node_ids <- trafikklenker_element$START_NODE_OID %>% 
#   unique()
# unique_end_node_ids <- trafikklenker_element$END_NODE_OID %>% 
#   unique()
# 
# unique_node_ids <- c(unique_start_node_ids, unique_end_node_ids) %>% 
#   unique()
# 
# kryss_query = paste0("SELECT * FROM \"Kryss\" WHERE FEATURE_OID IN (",
#                      stringr::str_c(unique_node_ids, collapse = ", "),
#                      ")")
# 
# kryss <- sf::st_read(geopackage_file, "Kryss",
#                      as_tibble = TRUE,
#                      query = kryss_query) %>% 
#   sf::st_zm(drop = T, what = "ZM") %>% 
#   dplyr::select(GEOMETRY) %>% 
#   sf::st_transform("+proj=longlat +datum=WGS84")
```



```{r manipulate_links}
trafikklenker_combined <- trafikklenker_element %>%
  sf::st_zm(drop = T, what = "ZM") %>% 
  dplyr::select(GEOMETRY, FEATURE_OID) %>% 
  dplyr::group_by(FEATURE_OID) %>% 
  dplyr::summarise(combined_geometry = sf::st_combine(GEOMETRY)) %>% 
  dplyr::mutate(line_length = round(sf::st_length(combined_geometry),
                                    digits = 1)) %>% 
  # Need to transform for leaflet plotting
  sf::st_transform("+proj=longlat +datum=WGS84")

# TODO: transform all combined, and write to file
# TODO: find road system reference segment for each link

# Filter by municipality polygon
#kommunenr <- alle_kommuner$nummer[alle_kommuner$navn == "Trondheim"] %>% 
#  as.character()

#kommune_polygon <- hent_kommune_v3(kommunenr)
# TODO: Consider simplifying polygon by st_simplify

#trafikklenker_kommune <- trafikklenker_combined %>% 
#  dplyr::mutate(innafor = sf::st_intersects(trafikklenker_combined, kommune_polygon, sparse = FALSE))

#trafikklenker_trondheim <- trafikklenker_kommune %>% 
#  filter(innafor == TRUE)
```


```{r plot}
leaflet(width = "100%",
          height = 700,
          options = leafletOptions(crs = nvdb_crs,
                                   zoomControl = F)) %>%
  addTiles(urlTemplate = nvdb_map_url,
           attribution = nvdb_map_attribution) %>%
   addPolylines(data = trafikklenker_combined, #trafikklenker_trondheim,
                popup = ~htmlEscape(line_length),
                highlightOptions = highlightOptions(bringToFront = TRUE,
                                                    sendToBack = TRUE,
                                                    color = "white",
                                                    opacity = 0.7)) #%>% 
  # addPolylines(data = kryss,
  #              fill = TRUE,
  #              fillColor = "black",
  #              highlightOptions = highlightOptions(bringToFront = TRUE,
  #                                                  sendToBack = TRUE,
  #                                                  color = "black",
  #                                                  opacity = 0.7)) %>% 
  #addPolygons(data = kommune_polygon,
  #            fill = FALSE)

# TODO: Add more labels
```

---
title: "Lengde- og kjøretøyklassifisering i Norge"
output: html_notebook
---


```{r setup, include = FALSE, echo = FALSE}
# Packages
library(tidyverse)
library(flextable)
library(hexbin)

source("H:/Programmering/R/byindeks/rmd_setup.R")
# knitr options
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE)

# Data is prepared in vehicle_register_data_prep.R
```


# Bakgrunn
Kjøretøyregisteret er et åpent datasett, og i denne analysen er det sett på sammenhengen mellom kjøretøylengde og klassifisering. Kjøretøy kan klassifiseres etter ulike parametre. I Kjøretøyforskriften benyttes oftest tillatt totalvekt, der det vanligste skillet er 3,5 tonn som er skillet mellom lett og tungt kjøretøy.

I trafikkdatasammenheng har lengdeklassifisering vært benyttet i mange år. Denne er ment som en tilnærming til inndeling i lette og tunge kjøretøy. Lengdegrensen har alltid vært 5,6 m.

Men hvor god er sammenhengen mellom lengdegrensen på 5,6 m og skillet mellom lett og tung på 3,5 tonn tillatt totalvekt?


## Datagrunnlag
Datagrunnlaget i denne analysen er alle kjøretøy som har status "registrert". Kjøretøy som er avskiltet eller vraket inngår ikke. Videre er det begrenset til kjøretøy som er registrert første gang etter 1.1.2000, da eldre kjøretøy antas å utgjøre en neglisjerbar andel av kjørte kilometer på det norske vegnettet. 

Videre er utvalget begrenset til følgende kjøretøygrupper slik de er definert i Kjøretøyforskriften:

  - M1 (personbil, maks 8 sitteplasser)
  - M2 (minibuss, flere enn 8 sitteplasser, maks 5 tonn totalvekt)
  - N1 (lett varebil, maks 3,5 tonn totalvekt)
  - N2 (lett lastebil, totalvekt mellom 3,5 og 12 tonn)

Utvalget inkluderer også de såkalte terrenggående kjøretøyene i de samme kjøretøygruppene, som i Kjøretøyforskriften er gruppert i kodene M1G, M2G, N1G og N2G. En ganske vanlig personbil som Toyota Land Cruiser er blant disse.


# Analyse
Ved å kategorisere alle kjøretøy etter kombinasjon av lengde og tillatt totalvekt, kan de deles inn i disse kategoriene:

  - Korte og lette: under 5,6 m og opp til og med 3,5 tonn.
  - Korte og tunge: under 5,6 m og over 3,5 tonn.
  - Lange og lette: 5,6 m eller mer og opp til og med 3,5 tonn.
  - Lange og tunge: 5,6 m eller mer og over 3,5 tonn.
  
Den første og siste kategorien er i harmoni med tanken om å skille lette og tunge kjøretøy. De to midterste kategoriene er i denne sammenhengen selvmotsigende, og bør inneholde så få kjøretøy som mulig.

I de følgende figurene er der vist hvordan kjøretøyene fordeler seg i disse fire kategoriene for ulike valg av lengdegrensen.



```{r scatterplot}
#Spredningsplott for kun 200 000 av de 1,6 mill. kjøretøyene:
# all_small_vehicles %>% 
#   dplyr::slice(1:200000) %>% 
#   ggplot(aes(tekn_lengde, tekn_totvekt)) +
#   ggplot2::geom_point() +
#   geom_vline(aes(xintercept = 5.6), color = "#ed1c2e", alpha = 0.6) +
#   geom_hline(aes(yintercept = 3.5), color = "#ed1c2e", alpha = 0.6) +
#   facet_wrap(vars(tekn_tknavn)) +
#   theme_bw() +
#   labs(x = "\nKjøretøylengde (m)", y = "Tillatt totalvekt (tonn)\n") +
#   ggtitle("Sammenheng mellom lengde og tillatt totalvekt")
```


```{r vegtek}
# vegtek_columns_to_be_removed <- c("tekn_drivst",
#                                   "tekn_euronorm_ny",
#                                   "tekn_hybrid",
#                                   "tekn_hybrid_kategori",
#                                   "tekn_merkenavn")
# 
# vehicle_info %>% 
#         dplyr::select(!tidyselect::all_of(vegtek_columns_to_be_removed)) %>% 
#         writexl::write_xlsx(path = "kjoretoy_O3.xlsx")
```

```{r 3d}
#Forsøk på tredimensjonalt spredningsplott. Lys farge indikerer større antall kjøretøy. Alle 1,6 mill. kjøretøyene.
# all_small_vehicles %>% 
#   #dplyr::slice(1:200000) %>% 
#   ggplot(aes(tekn_lengde, tekn_totvekt)) +
#   ggplot2::geom_hex() +
#   geom_vline(aes(xintercept = 5.6), color = "#ed1c2e", alpha = 0.6) +
#   geom_hline(aes(yintercept = 3.5), color = "#ed1c2e", alpha = 0.6) +
#   facet_wrap(vars(tekn_tknavn)) +
#   theme_bw() +
#   labs(x = "\nKjøretøylengde (m)", y = "Tillatt totalvekt (tonn)\n") +
#   ggtitle("Sammenheng mellom lengde og tillatt totalvekt")
```


```{r bin_5.4}
vehicles_5.4_grouped %>% 
  ggplot(aes(kategori, antall)) +
  ggplot2::geom_col() +
  geom_text(aes(label = antall,
                   y = 1e5),
              color = "grey",
              position = position_dodge(0.9),
              vjust = 0) +
  facet_wrap(vars(tekn_tknavn)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
        panel.grid.minor.x = element_blank()) +
  labs(x = "\nKategori", y = "Antall\n") +
  ggtitle("Sammenheng mellom lengde og tillatt totalvekt",
          subtitle = "Lengdeskille på 5,4 m")
```

```{r bin_5.6}
vehicles_5.6_grouped %>% 
  ggplot(aes(kategori, antall)) +
  ggplot2::geom_col() +
  geom_text(aes(label = antall,
                   y = 1e5),
              color = "grey",
              position = position_dodge(0.9),
              vjust = 0) +
  facet_wrap(vars(tekn_tknavn)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
        panel.grid.minor.x = element_blank()) +
  labs(x = "\nKategori", y = "Antall\n") +
  ggtitle("Sammenheng mellom lengde og tillatt totalvekt",
          subtitle = "Lengdeskille på 5,6 m")
```


```{r bin_5.8}
vehicles_5.8_grouped %>% 
  ggplot(aes(kategori, antall)) +
  ggplot2::geom_col() +
  geom_text(aes(label = antall,
                   y = 1e5),
              color = "grey",
              position = position_dodge(0.9),
              vjust = 0) +
  facet_wrap(vars(tekn_tknavn)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
        panel.grid.minor.x = element_blank()) +
  labs(x = "\nKategori", y = "Antall\n") +
  ggtitle("Sammenheng mellom lengde og tillatt totalvekt",
          subtitle = "Lengdeskille på 5,8 m")
```

```{r bin_6.0}
vehicles_6.0_grouped %>% 
  ggplot(aes(kategori, antall)) +
  ggplot2::geom_col() +
  geom_text(aes(label = antall,
                   y = 1e5),
              color = "grey",
              position = position_dodge(0.9),
              vjust = 0) +
  facet_wrap(vars(tekn_tknavn)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
        panel.grid.minor.x = element_blank()) +
  labs(x = "\nKategori", y = "Antall\n") +
  ggtitle("Sammenheng mellom lengde og tillatt totalvekt",
          subtitle = "Lengdeskille på 6.0 m")
```

I alle disse tilfellene er det "kort og lett" som dominerer i antall. Det er relativt små forskjeller i fordelingen.

For enklere å kunne sammenligne fordelingen mellom de ulike lengdevalgene, settes disse i samme visualisering hvor vi ser på forskjellige lengdeskiller og relativ fordeling av kjøretøyene i kategorier.


```{r rel_dist}
vehicles_relative %>% 
  dplyr::filter(lengdegrense %in% c(
    "5.4", "5.6", "6", "6.5", "7", "7.3", "7.4", "7.5", "8", "8.5"
    )) %>% 
  ggplot(aes(kategori, prosentandel, fill = lengdegrense)) +
  ggplot2::geom_col(position = "dodge") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
        panel.grid.minor.x = element_blank()) +
  scale_fill_brewer(palette = "Set3") +
  labs(x = "\nKategori", y = "Prosentandel (%)\n") +
  ggtitle("Sammenheng mellom lengde og tillatt totalvekt")
```

Ser nærmere på de to mellomkategoriene som vi vil ha færrest mulig kjøretøy i.

```{r rel_dist_closer}
vehicles_relative %>%
  dplyr::filter(kategori %in% c("kort_og_tung", "lang_og_lett")) %>% 
  ggplot(aes(lengdegrense, prosentandel, fill = kategori)) +
  ggplot2::geom_col(position = "stack") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
        panel.grid.minor.x = element_blank()) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "\nLengdegrense", y = "Prosentandel (%)\n") +
  ggtitle("Sammenheng mellom lengde og tillatt totalvekt",
          subtitle = "Andel kjøretøy i blandet kategori")
```

Konklusjonen er at 7,5 m er det optimale, men at forskjellen ikke er mer enn omkring 1,5 prosentpoeng fra 5,6 m. Ved 5,6 m er ca. 2,2 % av kjøretøyene i Kjøretøyregisteret i en av blandingskategoriene. Med 7,5 m er andelen 0,7 %. Det er et markant dropp ved 6 m, og dette harmonerer med det både EMU3 og LM benytter som et av kriteriene for sin klassifisering.


## Korte og tunge
Med 5,6 m som grense er det kun 500 kjøretøy som samtidig er korte og tunge. Typisk er dette SUV-er, små varebiler eller veldig små lastebiler. Med 6,0 m som grense økes denn gruppa til 2 200 kjøretøy, men den består av de samme typene.


## Lange og lette
Mange kjøretøy er definert med tillatt totalvekt på nøyaktig 3,5 tonn (tilpasset krav til førerkort, avgift m.m.). Disse er det 35 000 av når lengdegrensen er 5,6 m. Typisk er disse varebiler og bobiler.


## Overrepresentasjon av bobiler
Det er velkjent at bobiler i perioder utgjør en større andel av kjøretøyene på vegen enn de utgjør i selve kjøretøyregisteret. Dette vil gjerne være tilfelle på (Nasjonale) turistveger i juni. En stor andel av disse er definert som lette (tillatt totalvekt på akkurat 3,5 tonn), men er betydelig lenger enn 5,6 m, typisk 6,0-7,5 m. Disse vil bli lengdeklassifisert over 5,6 m og føre til en for høy andel tunge.


## Overrepresentasjon av varebiler
I byområder er det høy andel varebiler. En andel av disse er definert som lette (tillatt totalvekt på akkurat 3,5 tonn), men er betydelig lenger enn 5,6 m, typisk 6,0-7,5 m. Disse vil bli lengdeklassifisert over 5,6 m og føre til en for høy andel tunge.


## Lette og korte biler med henger
Kombinasjonen av lette og korte biler med hvilken som helst henger, vil gi samlet lengde over 5,6 m. Disse vil bli lengdeklassifisert over 5,6 m og føre til en for høy andel tunge. Overrepresentasjon av dette vil typisk være sommertrafikk med campingvogn og lastehenger ved hytteområder.


# Feilkilder
Fordelingene presentert over er teoretiske og tar ikke hensyn til at ulike kjøretøy benyttes ulikt. Det kan være at lengre kjøretøy kjører mer enn korte, og at "problemområdet" rundt 5,6 m utgjør en større andel av trafikkarbeidet enn i Kjøretøyregisteret.

Lengdemålinger har alltid noe usikkerhet knyttet til seg. I hvilken grad påvirker dette fordelingen av lette og tunge? Se egen rapport.

